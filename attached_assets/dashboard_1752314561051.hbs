 <!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<!-- Dashboard Detail View Content -->
<style>
    /* Dashboard-specific styles */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1rem;
        min-height: 200px;
        padding-bottom: 120px; /* Space for floating toolbar */
    }

    .dashboard-block {
        cursor: grab;
        transition: all 0.2s ease;
        position: relative;
    }

    .dashboard-block:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .dashboard-block:active {
        cursor: grabbing;
    }

    .dashboard-block.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
        z-index: 1000;
    }

    .dashboard-block.drag-over {
        border: 2px dashed #4f46e5;
        background-color: #f8fafc;
    }

    /* Add block buttons */
    .add-block-button {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        background-color: #f9fafb;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s ease;
        grid-column: span 4;
    }

    .add-block-button:hover {
        border-color: #4f46e5;
        background-color: #f0f9ff;
        color: #4f46e5;
        transform: translateY(-2px);
    }

    .add-block-button.last {
        grid-column: 1 / -1;
        margin-top: 1rem;
    }

    /* Empty dashboard state */
    .empty-dashboard-with-add {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1rem;
        padding: 2rem 0;
    }

    /* Drop zone indicator */
    .drop-zone {
        min-height: 60px;
        border: 2px dashed transparent;
        border-radius: 8px;
        margin: 0.5rem 0;
        transition: all 0.2s ease;
    }

    .drop-zone.active {
        border-color: #4f46e5;
        background-color: #eff6ff;
    }

    /* Drag handle styling */
    .drag-handle {
        opacity: 0;
        transition: opacity 0.2s ease;
        cursor: grab;
    }

    .dashboard-block:hover .drag-handle {
        opacity: 1;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    /* Block sizing */
    .block-1 { grid-column: span 1; }
    .block-2 { grid-column: span 2; }
    .block-3 { grid-column: span 3; }
    .block-4 { grid-column: span 4; }
    .block-5 { grid-column: span 5; }
    .block-6 { grid-column: span 6; }
    .block-7 { grid-column: span 7; }
    .block-8 { grid-column: span 8; }
    .block-9 { grid-column: span 9; }
    .block-10 { grid-column: span 10; }
    .block-11 { grid-column: span 11; }
    .block-12 { grid-column: span 12; }

    /* Floating Mini Toolbar */
    .floating-toolbar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        border: 1px solid #e5e7eb;
        z-index: 1000;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: move;
        user-select: none;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
    }

    .floating-toolbar.dragging {
        cursor: grabbing;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        transform: translateX(-50%) scale(1.02);
    }

    .toolbar-section {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: #e5e7eb;
        margin: 0 8px;
    }

    .toolbar-btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        background: transparent;
        color: #6b7280;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .toolbar-btn:hover {
        background: #f3f4f6;
        color: #374151;
        transform: translateY(-1px);
    }

    .toolbar-btn.active {
        background: #4f46e5;
        color: white;
    }

    .toolbar-btn.primary {
        background: #4f46e5;
        color: white;
    }

    .toolbar-btn.primary:hover {
        background: #4338ca;
    }

    .toolbar-btn.success {
        background: #10b981;
        color: white;
    }

    .toolbar-btn.success:hover {
        background: #059669;
    }

    .drag-handle {
        color: #9ca3af;
        cursor: move;
        padding: 4px;
        border-radius: 4px;
    }

    .drag-handle:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* Block controls */
    .block-controls {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
        display: flex;
        gap: 4px;
        background: rgba(255, 255, 255, 0.95);
        padding: 4px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .dashboard-block:hover .block-controls {
        opacity: 1;
    }

    .block-control-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 4px;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .block-control-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .block-control-btn.danger:hover {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* AI input styling */
    .ai-input {
        transition: all 0.2s ease;
    }

    .ai-input:focus {
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* AI input and toggle styles */
    .ai-input-section {
        transition: all 0.3s ease;
    }

    .ai-input-section.collapsed {
        display: none;
    }

    .ai-toggle-button {
        transition: all 0.2s ease;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
    }

    .ai-toggle-button:hover {
        background: linear-gradient(135deg, #4338ca, #6d28d9);
        transform: scale(1.05);
    }

    .ai-toggle-button.active {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .ai-toggle-button.processing {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
    }

    /* Smart AI input positioning */
    .ai-input-container {
        position: relative;
    }

    .ai-input-full {
        margin-bottom: 16px;
    }

    .ai-input-compact {
        position: absolute;
        top: -48px;
        right: 0;
        z-index: 10;
        width: 300px;
        max-width: calc(100vw - 40px);
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        padding: 12px;
    }

    .ai-input-compact input {
        width: 100%;
        margin-bottom: 8px;
    }

    .ai-input-compact .ai-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .ai-input-compact .ai-actions button {
        padding: 4px 8px;
        font-size: 11px;
    }

    /* Inline block descriptions */
    .block-description {
        margin-top: 12px;
        padding: 8px 12px;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.4;
        color: #64748b;
        transition: all 0.2s ease;
    }

    .block-description.hidden {
        display: none;
    }

    .block-description:empty {
        display: none;
    }

    /* Editable description styling */
    .block-description-input {
        background: transparent;
        border: 1px dashed #cbd5e1;
        color: #64748b;
        font-size: 12px;
        line-height: 1.4;
        padding: 8px 12px;
        border-radius: 6px;
        width: 100%;
        resize: none;
        transition: all 0.2s ease;
    }

    .block-description-input:hover {
        border-color: #94a3b8;
        background-color: #f1f5f9;
    }

    .block-description-input:focus {
        outline: none;
        border-color: #4f46e5;
        border-style: solid;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .block-description-input::placeholder {
        color: #94a3b8;
        font-style: italic;
    }

    /* Description toggle button */
    .description-toggle {
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .description-toggle:hover {
        opacity: 1;
    }

    .description-toggle.active {
        color: #4f46e5;
        opacity: 1;
    }

    /* Keep the description indicator but make it less prominent */
    .block-has-description::before {
        content: '';
        position: absolute;
        top: 8px;
        right: 8px;
        width: 4px;
        height: 4px;
        background-color: #10b981;
        border-radius: 50%;
        z-index: 5;
        opacity: 0.5;
    }

    .block-appear {
        animation: blockAppear 0.6s ease-out;
    }

    @keyframes blockAppear {
        0% { 
            opacity: 0; 
            transform: scale(0.8) translateY(20px); 
        }
        50% { 
            opacity: 0.7; 
            transform: scale(1.05) translateY(-5px); 
        }
        100% { 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
    }

    /* New block highlight */
    .new-block {
        border: 2px solid #10b981;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }

    .new-block::before {
        content: 'New';
        position: absolute;
        top: -8px;
        right: 8px;
        background: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        z-index: 10;
    }

    .insight-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .insight-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 20px -4px rgba(0, 0, 0, 0.1);
        border-color: #e5e7eb;
    }

    .insight-card.saved {
        border-color: #10b981;
        background-color: #f0fdf4;
    }

    .insight-chart-container {
        height: 200px;
        position: relative;
    }

    .insight-category-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
    }

    /* Loading animation for insights */
    .insights-loading {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Smart insights modal specific styles */
    .insights-modal-content {
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Synthetic data preview styles */
    .synthetic-preview {
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
    }

    /* Input method radio styles */
    .input-method-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .input-method-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .input-method-card.selected {
        border-color: #4f46e5;
        background-color: #f8faff;
    }

    /* Modal backdrop */
    .modal-backdrop {
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Copy animation */
    .copy-success {
        animation: pulse 0.6s ease-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Responsive adjustments for mobile */
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            padding-bottom: 80px;
        }
        
        .block-1, .block-2, .block-3, .block-4, .block-5, .block-6,
        .block-7, .block-8, .block-9, .block-10, .block-11, .block-12 {
            grid-column: span 1;
        }

        .floating-toolbar {
            bottom: 10px;
            left: 10px;
            right: 10px;
            transform: none;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 12px;
        }

        .toolbar-btn {
            font-size: 13px;
            padding: 6px 10px;
        }

        .toolbar-section {
            gap: 6px;
        }

        .ai-input-compact {
            width: 250px;
            top: -52px;
        }
    }

    /* Dashboard Info Panel */
    .dashboard-info-panel {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .dashboard-info-panel.hidden {
        display: none;
    }
</style>

<!-- Loading State -->
<div id="dashboard-loading" class="flex justify-center items-center h-64">
    <div class="flex items-center space-x-2">
        <i class="fas fa-spinner spinner text-indigo-600 text-xl"></i>
        <span class="text-gray-600">Loading dashboard...</span>
    </div>
</div>

<!-- Error State -->
<div id="error-state" class="hidden text-center py-12">
    <div class="h-24 w-24 bg-red-100 mx-auto rounded-full flex items-center justify-center mb-4">
        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">Dashboard Not Found</h3>
    <p class="text-gray-500 mb-4">The dashboard you're looking for doesn't exist or you don't have access to it.</p>
    <a href="/projects" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Projects
    </a>
</div>

<!-- Main Dashboard Content -->
<div id="dashboard-content" class="hidden">
    <!-- Dashboard Info Panel (Hidden by default) -->
    <div id="dashboard-info-panel" class="dashboard-info-panel hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Dashboard Information</h3>
            <button id="close-info-panel" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Dashboard Title (Editable) -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Dashboard Title</label>
            <input 
                id="dashboard-title-edit" 
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Enter dashboard title..."
            >
        </div>
        
        <!-- Dashboard Description -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea 
                id="dashboard-description-edit" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Add dashboard description..."
                rows="3"
            ></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button id="cancel-info-edit" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                Cancel
            </button>
            <button id="save-info-edit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Save Changes
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-dashboard" class="text-center py-16">
        <div class="h-24 w-24 bg-gray-100 mx-auto rounded-full flex items-center justify-center mb-6">
            <i class="fas fa-chart-line text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-xl font-medium text-gray-900 mb-3">Start Building Your Dashboard</h3>
        <p class="text-gray-500 mb-8 max-w-md mx-auto">Add blocks to create visualizations, notes, and insights for your data analysis</p>
        
        <!-- Quick Start Options -->
        <div class="empty-dashboard-with-add">
            <div class="add-block-button first" onclick="addBlockAtPosition(0, 'ai')">
                <div class="text-center">
                    <i class="fas fa-robot text-3xl text-indigo-600 mb-3"></i>
                    <div class="text-lg font-medium text-gray-800 mb-1">AI Visualization</div>
                    <div class="text-sm text-gray-500">Ask AI to create charts from your data</div>
                </div>
            </div>
            
            <div class="add-block-button" onclick="addBlockAtPosition(0, 'text')">
                <div class="text-center">
                    <i class="fas fa-align-left text-2xl text-green-600 mb-2"></i>
                    <div class="text-sm font-medium text-gray-800">Text Block</div>
                    <div class="text-xs text-gray-500">Add notes and insights</div>
                </div>
            </div>
            
            <div class="add-block-button" onclick="addBlockAtPosition(0, 'chart')">
                <div class="text-center">
                    <i class="fas fa-chart-bar text-2xl text-blue-600 mb-2"></i>
                    <div class="text-sm font-medium text-gray-800">Chart Block</div>
                    <div class="text-xs text-gray-500">Manual chart creation</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div id="dashboard-grid" class="dashboard-grid hidden">
        <!-- Blocks will be rendered here -->
    </div>
</div>

<!-- Floating Mini Toolbar -->
<div id="floating-toolbar" class="floating-toolbar hidden">
    <!-- Drag Handle -->
    <div class="drag-handle" id="toolbar-drag-handle">
        <i class="fas fa-grip-vertical"></i>
    </div>
    
    <div class="toolbar-divider"></div>
    
    <!-- Dashboard Info -->
    <div class="toolbar-section">
        <button id="dashboard-info-btn" class="toolbar-btn" title="Dashboard Info">
            <i class="fas fa-info-circle"></i>
            <span class="hidden sm:inline">Info</span>
        </button>
    </div>
    
    <div class="toolbar-divider"></div>
    
    <!-- Block Tools -->
    <div class="toolbar-section">
        <button id="add-ai-block-btn" class="toolbar-btn" title="Add AI Block" onclick="addBlock('ai')">
            <i class="fas fa-robot"></i>
            <span class="hidden sm:inline">AI</span>
        </button>
        
        <button id="add-text-block-btn" class="toolbar-btn" title="Add Text Block" onclick="addBlock('text')">
            <i class="fas fa-align-left"></i>
            <span class="hidden sm:inline">Text</span>
        </button>
        
        <button id="add-chart-block-btn" class="toolbar-btn" title="Add Chart Block" onclick="addBlock('chart')">
            <i class="fas fa-chart-bar"></i>
            <span class="hidden sm:inline">Chart</span>
        </button>
    </div>
    
    <div class="toolbar-divider"></div>
    
    <!-- Smart Features -->
    <div class="toolbar-section">
        <button id="smart-insights-btn" class="toolbar-btn" title="Smart Insights">
            <i class="fas fa-magic"></i>
            <span class="hidden sm:inline">Insights</span>
        </button>
        
        <button id="data-sources-btn" class="toolbar-btn" title="Data Sources">
            <i class="fas fa-database"></i>
            <span class="hidden sm:inline">Data</span>
        </button>
    </div>
    
    <div class="toolbar-divider"></div>
    
    <!-- Actions -->
    <div class="toolbar-section">
        <button id="preview-btn" class="toolbar-btn" title="Preview Dashboard">
            <i class="fas fa-eye"></i>
            <span class="hidden sm:inline">Preview</span>
        </button>
        
        <button id="share-btn" class="toolbar-btn primary" title="Share Dashboard">
            <i class="fas fa-share-alt"></i>
            <span class="hidden sm:inline">Share</span>
        </button>
    </div>
    
    <!-- Save Status -->
    <div id="save-status" class="toolbar-section hidden">
        <span class="toolbar-btn success">
            <i class="fas fa-check-circle"></i>
            <span class="hidden sm:inline">Saved</span>
        </span>
    </div>
</div>

<!-- Data Sources Sidebar (Slide-in from right) -->
<div id="data-sources-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-40 border-l border-gray-200">
    <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800">Data Sources</h3>
            <button id="close-data-sources" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div id="data-sources-list" class="p-6">
        <!-- Data sources will be rendered here -->
    </div>
</div>

<!-- Backdrop for sidebar -->
<div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

<!-- Share Modal -->
<div id="share-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-lg shadow-xl rounded-lg bg-white">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <div>
                <h3 class="text-xl font-semibold text-gray-900">Share Dashboard</h3>
                <p class="text-sm text-gray-500 mt-1">Share your dashboard with others via link</p>
            </div>
            <button id="close-share-modal" class="p-2 rounded-md hover:bg-gray-100 focus:outline-none">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <!-- Link Section -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Dashboard Link</label>
                <div class="flex items-center space-x-3">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="share-link" 
                            readonly
                            class="block w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg bg-gray-50 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                            value=""
                        >
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i class="fas fa-link text-gray-400"></i>
                        </div>
                    </div>
                    <button 
                        id="copy-link-btn" 
                        class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all"
                    >
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Anyone with this link can view your dashboard
                </p>
            </div>

            <!-- Share Options -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Quick Share</label>
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        id="share-email" 
                        class="flex items-center justify-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                    >
                        <i class="fas fa-envelope text-gray-600"></i>
                        <span class="text-sm font-medium text-gray-700">Email</span>
                    </button>
                    <button 
                        id="share-social" 
                        class="flex items-center justify-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                    >
                        <i class="fas fa-share-alt text-gray-600"></i>
                        <span class="text-sm font-medium text-gray-700">More</span>
                    </button>
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="text-center">
                <button 
                    id="show-qr-btn" 
                    class="text-sm text-indigo-600 hover:text-indigo-700 font-medium"
                >
                    <i class="fas fa-qrcode mr-1"></i>
                    Show QR Code
                </button>
                <div id="qr-code-container" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="w-32 h-32 bg-white border-2 border-gray-200 mx-auto rounded-lg flex items-center justify-center">
                        <i class="fas fa-qrcode text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Scan to view dashboard</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Insights Modal -->
<div id="smart-insights-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-6xl shadow-xl rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <div>
                <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-magic text-purple-600 mr-3"></i>
                    Smart Insights
                </h3>
                <p class="text-sm text-gray-600 mt-2">AI-powered analysis of your data to discover hidden insights and trends</p>
            </div>
            <button id="close-insights-modal" class="p-2 rounded-md hover:bg-gray-100 focus:outline-none">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        
        <!-- Insights Generator Section -->
        <div id="insights-generator" class="mb-6">
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-6">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-lightbulb text-purple-600 text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Discover Data Insights</h4>
                    <p class="text-gray-600 mb-6 max-w-2xl mx-auto">
                        Our AI will analyze your data sources and generate intelligent questions and visualizations 
                        to help you uncover trends, patterns, and actionable insights.
                    </p>
                    
                    <!-- Insight Count Selector -->
                    <div class="flex items-center justify-center space-x-4 mb-6">
                        <label class="text-sm font-medium text-gray-700">Number of insights:</label>
                        <select id="insight-count" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="3" selected>3 insights</option>
                            <option value="4">4 insights</option>
                            <option value="5">5 insights</option>
                            <option value="6">6 insights</option>
                            <option value="8">8 insights</option>
                        </select>
                    </div>
                    
                    <button 
                        id="generate-insights-btn" 
                        class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 text-sm font-semibold shadow-lg transform transition-all hover:scale-105"
                    >
                        <i class="fas fa-magic mr-2"></i>
                        <span class="btn-text">Generate Smart Insights</span>
                        <i class="fas fa-spinner spinner ml-2 hidden"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Insights Results Section -->
        <div id="insights-results" class="hidden">
            <!-- Results Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <h4 class="text-lg font-semibold text-gray-800">Generated Insights</h4>
                    <span id="insights-count-badge" class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full">0</span>
                </div>
                <div class="flex space-x-3">
                    <button 
                        id="regenerate-insights-btn" 
                        class="px-4 py-2 text-sm text-purple-600 border border-purple-300 rounded-md hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                        <i class="fas fa-redo mr-2"></i>
                        Regenerate
                    </button>
                    <button 
                        id="save-all-insights-btn" 
                        class="px-4 py-2 text-sm text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                        <i class="fas fa-save mr-2"></i>
                        Save All
                    </button>
                </div>
            </div>
            
            <!-- Insights Grid -->
            <div id="insights-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-h-96 overflow-y-auto">
                <!-- Insight cards will be rendered here -->
            </div>
            
            <!-- Generate More Button -->
            <div class="text-center mt-6 pt-4 border-t border-gray-200">
                <button 
                    id="generate-more-insights-btn" 
                    class="px-4 py-2 text-sm text-purple-600 hover:text-purple-700 font-medium"
                >
                    <i class="fas fa-plus mr-2"></i>
                    Generate More Insights
                </button>
            </div>
        </div>
        
        <!-- No Data State -->
        <div id="no-data-state" class="hidden text-center py-8">
            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-database text-gray-400 text-2xl"></i>
            </div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">No Data Sources Found</h4>
            <p class="text-gray-500 mb-4">Add data sources to your dashboard first to generate smart insights.</p>
            <button 
                onclick="closeInsightsModal(); document.getElementById('add-datasource-btn').click();" 
                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
                <i class="fas fa-plus mr-2"></i>
                Add Data Source
            </button>
        </div>
    </div>
</div>

<!-- Add Data Source Modal -->
<div id="add-datasource-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-lg font-medium text-gray-900">Add Data Source</h3>
            <button id="close-datasource-modal" class="p-1 rounded-md hover:bg-gray-100 focus:outline-none">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="mt-4">
            <form id="add-datasource-form">
                <div class="mb-4">
                    <label for="datasource-title" class="block text-sm font-medium text-gray-700 mb-1">Data Source Title <span class="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        id="datasource-title" 
                        name="title"
                        required
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                        placeholder="Enter data source name"
                    >
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Data Input Method</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <!-- Manual Input Card -->
                        <div class="input-method-card border border-gray-300 rounded-lg p-4 selected" onclick="selectInputMethod('text')">
                            <input type="radio" name="input-method" value="text" checked class="hidden">
                            <div class="text-center">
                                <i class="fas fa-keyboard text-2xl text-indigo-600 mb-2"></i>
                                <h4 class="text-sm font-semibold text-gray-800">Manual Input</h4>
                                <p class="text-xs text-gray-500 mt-1">Type or paste your data</p>
                            </div>
                        </div>
                        
                        <!-- File Upload Card -->
                        <div class="input-method-card border border-gray-300 rounded-lg p-4" onclick="selectInputMethod('file')">
                            <input type="radio" name="input-method" value="file" class="hidden">
                            <div class="text-center">
                                <i class="fas fa-file-upload text-2xl text-green-600 mb-2"></i>
                                <h4 class="text-sm font-semibold text-gray-800">File Upload</h4>
                                <p class="text-xs text-gray-500 mt-1">Upload CSV or JSON file</p>
                            </div>
                        </div>
                        
                        <!-- Synthetic Data Card -->
                        <div class="input-method-card border border-gray-300 rounded-lg p-4" onclick="selectInputMethod('synthetic')">
                            <input type="radio" name="input-method" value="synthetic" class="hidden">
                            <div class="text-center">
                                <i class="fas fa-magic text-2xl text-purple-600 mb-2"></i>
                                <h4 class="text-sm font-semibold text-gray-800">Synthetic Data</h4>
                                <p class="text-xs text-gray-500 mt-1">AI-generated sample data</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Input Section -->
                <div id="text-input-section" class="mb-4">
                    <label for="datasource-content" class="block text-sm font-medium text-gray-700 mb-1">Data Content</label>
                    <textarea 
                        id="datasource-content" 
                        name="content"
                        rows="6" 
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                        placeholder="Enter CSV or JSON data..."
                    ></textarea>
                    <small class="text-gray-500">Enter data in CSV or JSON format</small>
                </div>
                
                <!-- File Upload Section -->
                <div id="file-input-section" class="mb-4 hidden">
                    <label for="datasource-file" class="block text-sm font-medium text-gray-700 mb-1">Upload File</label>
                    <input 
                        type="file" 
                        id="datasource-file" 
                        name="file"
                        accept=".csv,.json,.txt"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    >
                    <small class="text-gray-500">Upload CSV, JSON, or text file</small>
                </div>
                
                <!-- Synthetic Data Section -->
                <div id="synthetic-input-section" class="mb-4 hidden">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-magic text-purple-600 mr-2"></i>
                            <h4 class="text-sm font-semibold text-purple-800">AI-Generated Synthetic Data</h4>
                        </div>
                        <p class="text-sm text-purple-700 mb-3">
                            Generate realistic sample data based on your existing data sources or create new sample datasets for analysis.
                        </p>
                        
                        <div class="mb-3">
                            <label for="synthetic-instructions" class="block text-sm font-medium text-purple-700 mb-1">Custom Instructions (Optional)</label>
                            <input 
                                type="text" 
                                id="synthetic-instructions" 
                                name="synthetic-instructions"
                                class="block w-full px-3 py-2 border border-purple-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-sm" 
                                placeholder="e.g., Generate sales data for a tech company, Include seasonal trends..."
                            >
                            <small class="text-purple-600">Describe what kind of data you want to generate</small>
                        </div>
                        
                        <button 
                            type="button" 
                            id="generate-synthetic-btn" 
                            class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 text-sm font-medium"
                        >
                            <i class="fas fa-magic mr-2"></i>
                            <span class="btn-text">Generate Synthetic Data</span>
                            <i class="fas fa-spinner spinner ml-2 hidden"></i>
                        </button>
                    </div>
                    
                    <!-- Synthetic Data Preview -->
                    <div id="synthetic-preview-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Generated Data Preview</label>
                        <div class="bg-gray-50 border border-gray-300 rounded-md p-3 mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <span id="synthetic-record-count" class="text-sm text-gray-600">0 records generated</span>
                                <button 
                                    type="button" 
                                    id="regenerate-synthetic-btn" 
                                    class="text-sm text-purple-600 hover:text-purple-700 font-medium"
                                >
                                    <i class="fas fa-redo mr-1"></i>
                                    Regenerate
                                </button>
                            </div>
                            <textarea 
                                id="synthetic-data-preview" 
                                class="synthetic-preview w-full bg-white border border-gray-300 rounded text-gray-800 p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                rows="8"
                                placeholder="Generated data will appear here..."
                            ></textarea>
                            <small class="text-gray-500 mt-1 block">You can edit the generated data before saving</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-datasource" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                    <button type="submit" id="submit-datasource" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="btn-text">Add Data Source</span>
                        <i class="fas fa-spinner spinner ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Block Modal -->
<div id="edit-block-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-lg shadow-xl rounded-lg bg-white">
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Edit Block</h3>
                <p class="text-sm text-gray-500 mt-1">Customize your block's title and description</p>
            </div>
            <button id="close-block-edit-modal" class="p-2 rounded-md hover:bg-gray-100 focus:outline-none">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div>
            <form id="edit-block-form">
                <!-- Block Title -->
                <div class="mb-4">
                    <label for="block-title-input" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-heading text-gray-500 mr-1"></i>
                        Block Title
                    </label>
                    <input 
                        type="text"
                        id="block-title-input" 
                        name="title"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" 
                        placeholder="Enter block title..."
                        required
                    >
                </div>
                
                <!-- Block Description -->
                <div class="mb-6">
                    <label for="block-description-input" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left text-gray-500 mr-1"></i>
                        Description (Optional)
                    </label>
                    <textarea 
                        id="block-description-input" 
                        name="description"
                        rows="4" 
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm resize-none" 
                        placeholder="Describe what this block shows or represents..."
                    ></textarea>
                    <div class="flex items-center mt-2 text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span>The description will appear as a tooltip when hovering over the block</span>
                    </div>
                </div>
                
                <!-- Preview -->
                <div id="tooltip-preview" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-eye text-gray-500 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Tooltip Preview</span>
                    </div>
                    <div class="bg-gray-800 text-white text-sm p-3 rounded-md shadow-lg inline-block max-w-full">
                        <div id="preview-text" class="break-words"></div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-block-edit" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                    <button type="submit" id="save-block-changes" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="btn-text">Save Changes</span>
                        <i class="fas fa-spinner spinner ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
    <!-- Toasts will be inserted here -->
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <i class="fas fa-spinner spinner text-indigo-600 text-xl"></i>
            <span class="text-gray-700">Processing...</span>
        </div>
    </div>
</div>

<!-- Dashboard Detail View JavaScript -->
<script>
    // Get dashboard ID from template variable (passed from server)
    const DASHBOARD_ID = '{{dashboardId}}'; // This comes from your web route
    
    // API Base URL
    const API_BASE_DASHBOARD = '/api';
    
    // Global state
    let currentDashboard = null;
    let currentProject = null;
    let blocks = [];
    let dataSources = [];
    let generatedSyntheticData = null;
    let currentInsights = [];
    let savedInsightIds = new Set();
    let descriptionsVisible = true; // Global description visibility state
    let aiInputStates = {}; // Track AI input visibility for each block
    let draggedElement = null;
    let dropZones = [];
    
    // Utility function to handle API responses consistently
    async function handleApiResponse(response) {
        console.log('API Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            
            try {
                const errorData = await response.json();
                console.log('API Error data:', errorData);
                if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (parseError) {
                console.log('Could not parse error response as JSON');
            }
            
            throw new Error(errorMessage);
        }
        
        const result = await response.json();
        console.log('API Response data:', result);
        
        if (!result.success) {
            throw new Error(result.message || 'API request failed');
        }
        
        return result;
    }

    // Updated helper function for API errors
    const handleApiError = (error, defaultMessage = 'An error occurred') => {
        console.error('API Error:', error);
        
        let message = defaultMessage;
        
        if (error.message) {
            message = error.message;
        } else if (typeof error === 'string') {
            message = error;
        }
        
        showToast(message, 'error');
        return message;
    };
    
    // Get dashboard ID from template variable
    function getDashboardIdFromUrl() {
        console.log('Using dashboard ID from template:', DASHBOARD_ID);
        return DASHBOARD_ID;
    }

    // Generate share link
    function generateShareLink() {
        const dashboardId = getDashboardIdFromUrl();
        return `${window.location.origin}/dashboards/live/${dashboardId}`;
    }

    // Utility functions
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        
        toast.className = `${bgColor} text-white px-6 py-3 rounded-md shadow-lg flex items-center space-x-2 transform transition-all duration-300 translate-x-full`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}-circle"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        document.getElementById('toast-container').appendChild(toast);
        
        // Animate in
        setTimeout(() => toast.classList.remove('translate-x-full'), 100);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showSaveStatus() {
        const saveStatus = document.getElementById('save-status');
        saveStatus.classList.remove('hidden');
        setTimeout(() => {
            saveStatus.classList.add('hidden');
        }, 2000);
    }

    // Input method selection
    function selectInputMethod(method) {
        // Update radio buttons
        document.querySelectorAll('input[name="input-method"]').forEach(radio => {
            radio.checked = radio.value === method;
        });
        
        // Update visual selection
        document.querySelectorAll('.input-method-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Show/hide relevant sections
        toggleInputMethod();
    }

    function toggleInputMethod() {
        const method = document.querySelector('input[name="input-method"]:checked').value;
        const textSection = document.getElementById('text-input-section');
        const fileSection = document.getElementById('file-input-section');
        const syntheticSection = document.getElementById('synthetic-input-section');
        
        // Hide all sections first
        textSection.classList.add('hidden');
        fileSection.classList.add('hidden');
        syntheticSection.classList.add('hidden');
        
        // Show the selected section
        if (method === 'text') {
            textSection.classList.remove('hidden');
        } else if (method === 'file') {
            fileSection.classList.remove('hidden');
        } else if (method === 'synthetic') {
            syntheticSection.classList.remove('hidden');
        }
    }

    // Synthetic data generation
    async function generateSyntheticData() {
        const btn = document.getElementById('generate-synthetic-btn');
        const btnText = btn.querySelector('.btn-text');
        const spinner = btn.querySelector('.spinner');
        const customInstructions = document.getElementById('synthetic-instructions').value;
        
        try {
            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            
            const response = await fetch(`${API_BASE_DASHBOARD}/generate-synthetic`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dashboardId: currentDashboard.id,
                    customInstructions: customInstructions
                })
            });
            
            const result = await handleApiResponse(response);
            generatedSyntheticData = result.data;
            
            // Display the generated data
            displaySyntheticDataPreview(result.data, result.recordCount);
            
            showToast(`Generated ${result.recordCount} synthetic records!`);
            
        } catch (error) {
            console.error('Error generating synthetic data:', error);
            handleApiError(error, 'Failed to generate synthetic data');
        } finally {
            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Generate Synthetic Data';
            spinner.classList.add('hidden');
        }
    }

    function displaySyntheticDataPreview(data, recordCount) {
        const container = document.getElementById('synthetic-preview-container');
        const preview = document.getElementById('synthetic-data-preview');
        const countSpan = document.getElementById('synthetic-record-count');
        
        // Show the preview container
        container.classList.remove('hidden');
        
        // Update record count
        countSpan.textContent = `${recordCount} records generated`;
        
        // Display the data in a formatted way
        preview.value = JSON.stringify(data, null, 2);
        
        // Auto-scroll to show the preview
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Smart Insights functions
    function openSmartInsightsModal() {
        const modal = document.getElementById('smart-insights-modal');
        
        // Check if we have data sources
        if (!dataSources || dataSources.length === 0) {
            document.getElementById('insights-generator').classList.add('hidden');
            document.getElementById('insights-results').classList.add('hidden');
            document.getElementById('no-data-state').classList.remove('hidden');
        } else {
            document.getElementById('insights-generator').classList.remove('hidden');
            document.getElementById('insights-results').classList.add('hidden');
            document.getElementById('no-data-state').classList.add('hidden');
        }
        
        modal.classList.remove('hidden');
    }

    function closeInsightsModal() {
        const modal = document.getElementById('smart-insights-modal');
        
        // If any insights were saved, show a brief confirmation
        if (savedInsightIds.size > 0) {
            showToast(`${savedInsightIds.size} insight(s) are now on your dashboard!`);
            
            // Ensure dashboard is fully refreshed
            renderDashboard();
        }
        
        modal.classList.add('hidden');
        
        // Reset state
        currentInsights = [];
        savedInsightIds.clear();
        document.getElementById('insights-results').classList.add('hidden');
        document.getElementById('insights-generator').classList.remove('hidden');
    }

    async function generateSmartInsights() {
        const btn = document.getElementById('generate-insights-btn');
        const btnText = btn.querySelector('.btn-text');
        const spinner = btn.querySelector('.spinner');
        const count = document.getElementById('insight-count').value;
        
        try {
            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Analyzing Data...';
            spinner.classList.remove('hidden');
            
            const response = await fetch(`${API_BASE_DASHBOARD}/generate-insights`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dashboardId: currentDashboard.id,
                    count: parseInt(count)
                })
            });
            
            const result = await handleApiResponse(response);
            
            // Defensive programming - handle different response structures
            const insights = result.data?.insights || result.insights || [];
            currentInsights = insights;
            
            // Display the insights
            displayInsights(insights);
            
            // Switch to results view
            document.getElementById('insights-generator').classList.add('hidden');
            document.getElementById('insights-results').classList.remove('hidden');
            
            showToast(`Generated ${insights.length} smart insights!`);
            
        } catch (error) {
            console.error('Error generating insights:', error);
            handleApiError(error, 'Failed to generate insights');
        } finally {
            // Reset button state
            btn.disabled = false;
            btnText.textContent = 'Generate Smart Insights';
            spinner.classList.add('hidden');
        }
    }

    function displayInsights(insights) {
        const grid = document.getElementById('insights-grid');
        const badge = document.getElementById('insights-count-badge');
        
        grid.innerHTML = '';
        badge.textContent = insights.length;
        
        insights.forEach((insight, index) => {
            const card = createInsightCard(insight, index);
            grid.appendChild(card);
        });
    }

    function createInsightCard(insight, index) {
        const card = document.createElement('div');
        card.className = 'insight-card bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden';
        card.id = `insight-card-${insight.id}`;
        
        // Category badge color mapping
        const categoryColors = {
            trend: 'bg-blue-100 text-blue-800',
            comparison: 'bg-green-100 text-green-800',
            distribution: 'bg-purple-100 text-purple-800',
            correlation: 'bg-orange-100 text-orange-800',
            performance: 'bg-red-100 text-red-800',
            anomaly: 'bg-yellow-100 text-yellow-800'
        };
        
        const categoryColor = categoryColors[insight.insight_category] || 'bg-gray-100 text-gray-800';
        
        card.innerHTML = `
            <!-- Chart Container -->
            <div class="insight-chart-container relative bg-gray-50">
                <span class="insight-category-badge absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-medium ${categoryColor}">
                    ${insight.insight_category}
                </span>
                <div id="chart-${insight.id}" class="w-full h-full"></div>
            </div>
            
            <!-- Card Content -->
            <div class="p-4">
                <h5 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-2">${insight.question}</h5>
                <p class="text-xs text-gray-600 mb-4 line-clamp-3">${insight.description}</p>
                
                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    <button 
                        onclick="saveInsightAsBlock('${insight.id}')" 
                        id="save-btn-${insight.id}"
                        class="flex-1 px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs font-medium transition-all"
                    >
                        <i class="fas fa-save mr-1"></i>
                        Save Block
                    </button>
                    <button 
                        onclick="previewInsight('${insight.id}')" 
                        class="px-3 py-2 text-purple-600 border border-purple-300 rounded-md hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs font-medium"
                    >
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Render the chart after the card is added to DOM
        setTimeout(() => {
            try {
                if (insight.chart_payload) {
                    const chartContainer = document.getElementById(`chart-${insight.id}`);
                    if (chartContainer) {
                        Highcharts.chart(chartContainer, {
                            ...insight.chart_payload,
                            credits: { enabled: false },
                            title: { text: null },
                            legend: { enabled: false }
                        });
                    }
                }
            } catch (error) {
                console.error('Error rendering insight chart:', error);
                const chartContainer = document.getElementById(`chart-${insight.id}`);
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 text-xs">Chart preview unavailable</div>';
                }
            }
        }, 100);
        
        return card;
    }

    async function saveInsightAsBlock(insightId) {
        const insight = currentInsights.find(i => i.id === insightId);
        if (!insight) return;
        
        const saveBtn = document.getElementById(`save-btn-${insightId}`);
        const card = document.getElementById(`insight-card-${insightId}`);
        
        try {
            // Update button state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner spinner"></i> Saving...';
            
            const response = await fetch(`${API_BASE_DASHBOARD}/save-insight-block`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dashboardId: currentDashboard.id,
                    insight: insight
                })
            });
            
            const result = await handleApiResponse(response);
            
            // Add to local blocks array immediately
            blocks.push(result.data.block);
            
            // Mark as saved in the modal
            savedInsightIds.add(insightId);
            card.classList.add('saved');
            saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved';
            saveBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            // Immediately update the dashboard with animation for new blocks
            renderDashboard(true);
            
            showToast('Block added to dashboard!');
            
        } catch (error) {
            console.error('Error saving insight:', error);
            handleApiError(error, 'Failed to save insight');
            
            // Reset button state on error
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i> Save Block';
        }
    }

    async function saveAllInsights() {
        const unsavedInsights = currentInsights.filter(insight => !savedInsightIds.has(insight.id));
        
        if (unsavedInsights.length === 0) {
            showToast('All insights are already saved!', 'info');
            return;
        }
        
        const saveAllBtn = document.getElementById('save-all-insights-btn');
        
        try {
            saveAllBtn.disabled = true;
            saveAllBtn.innerHTML = '<i class="fas fa-spinner spinner"></i> Saving All...';
            
            const response = await fetch(`${API_BASE_DASHBOARD}/save-insight-blocks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dashboardId: currentDashboard.id,
                    insights: unsavedInsights
                })
            });
            
            const result = await handleApiResponse(response);
            
            // Add all blocks to local array immediately
            blocks.push(...result.data.blocks);
            
            // Mark all as saved in the modal
            unsavedInsights.forEach(insight => {
                savedInsightIds.add(insight.id);
                const card = document.getElementById(`insight-card-${insight.id}`);
                const saveBtn = document.getElementById(`save-btn-${insight.id}`);
                
                if (card) card.classList.add('saved');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved';
                    saveBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            });
            
            // Immediately update the dashboard with animation for new blocks
            renderDashboard(true);
            
            showToast(`${result.data.blocks.length} blocks added to dashboard!`);
            
        } catch (error) {
            console.error('Error saving all insights:', error);
            handleApiError(error, 'Failed to save insights');
        } finally {
            saveAllBtn.disabled = false;
            saveAllBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save All';
        }
    }

    function previewInsight(insightId) {
        const insight = currentInsights.find(i => i.id === insightId);
        if (!insight) return;
        
        showToast(`Preview: ${insight.question}`, 'info');
    }

    async function regenerateSyntheticData() {
        await generateSyntheticData();
    }

    async function regenerateInsights() {
        await generateSmartInsights();
    }

    async function generateMoreInsights() {
        const currentCount = parseInt(document.getElementById('insight-count').value);
        const newCount = Math.min(currentCount + 2, 8); // Add 2 more, max 8
        
        document.getElementById('insight-count').value = newCount;
        await generateSmartInsights();
    }

    // Description management functions
    function toggleAllDescriptions() {
        descriptionsVisible = !descriptionsVisible;
        
        // Toggle all block descriptions
        document.querySelectorAll('.block-description').forEach(desc => {
            if (descriptionsVisible) {
                desc.classList.remove('hidden');
            } else {
                desc.classList.add('hidden');
            }
        });
    }

    function toggleBlockDescription(blockId) {
        const descDisplay = document.getElementById(`desc-display-${blockId}`);
        const toggleBtn = document.querySelector(`#block-${blockId} .description-toggle`);
        
        if (descDisplay) {
            const isHidden = descDisplay.classList.contains('hidden');
            
            if (isHidden) {
                descDisplay.classList.remove('hidden');
                toggleBtn.classList.add('active');
            } else {
                descDisplay.classList.add('hidden');
                toggleBtn.classList.remove('active');
            }
        }
    }

    function editDescriptionInline(blockId) {
        const descDisplay = document.getElementById(`desc-display-${blockId}`);
        const descInput = document.getElementById(`desc-input-${blockId}`);
        
        if (descDisplay && descInput) {
            descDisplay.classList.add('hidden');
            descInput.classList.remove('hidden');
            descInput.focus();
            
            // Auto-resize textarea
            descInput.style.height = 'auto';
            descInput.style.height = Math.max(descInput.scrollHeight, 40) + 'px';
        }
    }

    async function saveDescriptionInline(blockId, description) {
        const descDisplay = document.getElementById(`desc-display-${blockId}`);
        const descInput = document.getElementById(`desc-input-${blockId}`);
        const toggleBtn = document.querySelector(`#block-${blockId} .description-toggle`);
        
        try {
            // Update the description
            await updateBlockDescription(blockId, description);
            
            // Update the display
            if (description.trim()) {
                descDisplay.textContent = description;
                descDisplay.classList.remove('hidden');
                if (descriptionsVisible) {
                    toggleBtn.classList.add('active');
                }
                
                // Update block class
                const blockDiv = document.getElementById(`block-${blockId}`);
                blockDiv.classList.add('block-has-description');
            } else {
                descDisplay.innerHTML = '<em style="color: #94a3b8;">Click to add description...</em>';
                if (descriptionsVisible) {
                    descDisplay.classList.remove('hidden');
                }
                toggleBtn.classList.remove('active');
                
                // Update block class
                const blockDiv = document.getElementById(`block-${blockId}`);
                blockDiv.classList.remove('block-has-description');
            }
            
            descInput.classList.add('hidden');
            
        } catch (error) {
            showToast('Failed to save description', 'error');
            cancelDescriptionEdit(blockId);
        }
    }

    function cancelDescriptionEdit(blockId) {
        const descDisplay = document.getElementById(`desc-display-${blockId}`);
        const descInput = document.getElementById(`desc-input-${blockId}`);
        const block = blocks.find(b => b.id === blockId);
        
        if (descInput && block) {
            // Restore original value
            descInput.value = block.description || '';
        }
        
        if (descDisplay && descInput) {
            descInput.classList.add('hidden');
            if (descriptionsVisible) {
                descDisplay.classList.remove('hidden');
            }
        }
    }

    // AI Input Toggle Functions
    function toggleAIInput(blockId) {
        const aiInputSection = document.getElementById(`ai-input-section-${blockId}`);
        const aiToggleBtn = document.getElementById(`ai-toggle-${blockId}`);
        const input = document.getElementById(`ai-input-${blockId}`);
        
        if (!aiInputSection || !aiToggleBtn) return;
        
        const isCollapsed = aiInputSection.classList.contains('collapsed');
        
        if (isCollapsed) {
            // Show AI input
            aiInputSection.classList.remove('collapsed');
            aiToggleBtn.classList.add('active');
            aiToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
            aiToggleBtn.title = 'Close AI input';
            aiInputStates[blockId] = true;
            
            // Focus the input
            if (input) {
                setTimeout(() => input.focus(), 100);
            }
        } else {
            // Hide AI input
            aiInputSection.classList.add('collapsed');
            aiToggleBtn.classList.remove('active');
            aiToggleBtn.innerHTML = '<i class="fas fa-robot"></i>';
            aiToggleBtn.title = 'Ask AI about this chart';
            aiInputStates[blockId] = false;
            
            // Clear input value
            if (input) {
                input.value = '';
            }
        }
    }

    function setAIButtonProcessing(blockId, isProcessing) {
        const aiToggleBtn = document.getElementById(`ai-toggle-${blockId}`);
        if (aiToggleBtn) {
            if (isProcessing) {
                aiToggleBtn.classList.add('processing');
                aiToggleBtn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
                aiToggleBtn.disabled = true;
            } else {
                aiToggleBtn.classList.remove('processing');
                aiToggleBtn.innerHTML = '<i class="fas fa-robot"></i>';
                aiToggleBtn.disabled = false;
            }
        }
    }

    // Preview dashboard
    function previewDashboard() {
        const dashboardId = getDashboardIdFromUrl();
        const previewUrl = `/dashboards/live/${dashboardId}`;
        window.open(previewUrl, '_blank');
    }

    // Share modal functions
    function openShareModal() {
        const modal = document.getElementById('share-modal');
        const shareLink = document.getElementById('share-link');
        shareLink.value = generateShareLink();
        modal.classList.remove('hidden');
    }

    function closeShareModal() {
        document.getElementById('share-modal').classList.add('hidden');
    }

    function copyShareLink() {
        const shareLink = document.getElementById('share-link');
        const copyBtn = document.getElementById('copy-link-btn');
        
        shareLink.select();
        shareLink.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
            
            // Visual feedback
            copyBtn.classList.add('copy-success');
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            
            setTimeout(() => {
                copyBtn.classList.remove('copy-success');
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            }, 2000);
            
            showToast('Link copied to clipboard!');
        } catch (err) {
            showToast('Failed to copy link', 'error');
        }
    }

    function shareViaEmail() {
        const shareLink = generateShareLink();
        const subject = encodeURIComponent(`Check out this dashboard: ${currentDashboard?.title || 'Untitled Dashboard'}`);
        const body = encodeURIComponent(`I wanted to share this dashboard with you: ${shareLink}`);
        window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
    }

    function shareViaSocial() {
        const shareLink = generateShareLink();
        if (navigator.share) {
            navigator.share({
                title: currentDashboard?.title || 'Dashboard',
                text: 'Check out this dashboard',
                url: shareLink
            }).catch(() => {
                // Fallback to copying link
                copyShareLink();
            });
        } else {
            copyShareLink();
        }
    }

    function toggleQRCode() {
        const container = document.getElementById('qr-code-container');
        const btn = document.getElementById('show-qr-btn');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-qrcode mr-1"></i>Hide QR Code';
        } else {
            container.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-qrcode mr-1"></i>Show QR Code';
        }
    }

    // Data Sources Functions
    function toggleDataSources() {
        const sidebar = document.getElementById('data-sources-sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const btn = document.getElementById('data-sources-btn');
        
        if (sidebar.classList.contains('translate-x-full')) {
            sidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('hidden');
            btn.classList.add('active');
        } else {
            sidebar.classList.add('translate-x-full');
            backdrop.classList.add('hidden');
            btn.classList.remove('active');
        }
    }

    // Dashboard Info Panel Control
    function toggleDashboardInfo() {
        const panel = document.getElementById('dashboard-info-panel');
        const btn = document.getElementById('dashboard-info-btn');
        
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            btn.classList.add('active');
            
            // Populate current values
            if (currentDashboard) {
                document.getElementById('dashboard-title-edit').value = currentDashboard.title || '';
                document.getElementById('dashboard-description-edit').value = currentDashboard.description || '';
            }
        } else {
            panel.classList.add('hidden');
            btn.classList.remove('active');
        }
    }

    // API functions
    async function fetchDashboard(dashboardId) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/dashboards/${dashboardId}`);
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error fetching dashboard:', error);
            throw error;
        }
    }

    async function updateDashboard(dashboardId, updates) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/dashboards/${dashboardId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updates)
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error updating dashboard:', error);
            throw error;
        }
    }

    async function createBlock(dashboardId, blockData) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/dashboards/${dashboardId}/blocks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(blockData)
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error creating block:', error);
            throw error;
        }
    }

    async function updateBlock(blockId, updates) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/blocks/${blockId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updates)
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error updating block:', error);
            throw error;
        }
    }

    async function deleteBlock(blockId) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/blocks/${blockId}`, {
                method: 'DELETE'
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error deleting block:', error);
            throw error;
        }
    }

    async function createDataSource(dashboardId, formData) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/dashboards/${dashboardId}/datasources`, {
                method: 'POST',
                body: formData
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error creating data source:', error);
            throw error;
        }
    }

    async function askAI(query, blockId, dashboardId) {
        try {
            const response = await fetch(`${API_BASE_DASHBOARD}/ai`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query,
                    blockId,
                    dashboardId
                })
            });
            
            const result = await handleApiResponse(response);
            return result.data;
        } catch (error) {
            console.error('Error with AI request:', error);
            throw error;
        }
    }

    async function updateBlockDescription(blockId, description) {
        try {
            await updateBlock(blockId, { description });
            
            // Update local state
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].description = description;
            }
            
            showSaveStatus();
        } catch (error) {
            handleApiError(error, 'Failed to update block description');
        }
    }

    // UI functions
    function renderDashboard(highlightNewBlocks = false) {
        const loading = document.getElementById('dashboard-loading');
        const content = document.getElementById('dashboard-content');
        const emptyState = document.getElementById('empty-dashboard');
        const grid = document.getElementById('dashboard-grid');
        const toolbar = document.getElementById('floating-toolbar');
        
        loading.classList.add('hidden');
        content.classList.remove('hidden');
        toolbar.classList.remove('hidden');
        
        if (!blocks || blocks.length === 0) {
            emptyState.classList.remove('hidden');
            grid.classList.add('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        grid.classList.remove('hidden');
        
        // Store existing block IDs to identify new ones
        const existingBlockIds = new Set();
        grid.querySelectorAll('.dashboard-block').forEach(block => {
            const blockId = block.id.replace('block-', '');
            existingBlockIds.add(blockId);
        });
        
        // Clear and rebuild grid
        grid.innerHTML = '';
        
        // Sort blocks by position
        const sortedBlocks = [...blocks].sort((a, b) => (a.position || 0) - (b.position || 0));
        
        // Render blocks with drag and drop
        sortedBlocks.forEach((block, index) => {
            const blockElement = createBlockElement(block);
            
            // Add drag and drop functionality
            setupDragAndDrop(blockElement, block, index);
            
            // Add animation and highlight for new blocks
            if (highlightNewBlocks && !existingBlockIds.has(block.id)) {
                blockElement.classList.add('block-appear', 'new-block');
                
                // Remove highlight after animation
                setTimeout(() => {
                    blockElement.classList.remove('new-block');
                }, 3000);
            }
            
            grid.appendChild(blockElement);
        });
        
        // Always add "Add Block" button at the end (when blocks exist)
        const addLastButton = createAddBlockButton('last');
        grid.appendChild(addLastButton);
    }

    function createAddBlockButton(position) {
        const button = document.createElement('div');
        button.className = `add-block-button ${position}`;
        
        if (position === 'first') {
            button.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-plus-circle text-3xl mb-2"></i>
                    <div class="text-sm font-medium">Add Block at Top</div>
                    <div class="text-xs opacity-75">Create your first visualization</div>
                </div>
            `;
            button.addEventListener('click', () => addBlockAtPosition(0));
        } else {
            // Always available bottom button
            button.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-plus text-2xl mb-2"></i>
                    <div class="text-sm font-medium">Add Block</div>
                    <div class="text-xs opacity-75">Add another visualization</div>
                </div>
            `;
            button.addEventListener('click', () => addBlockAtPosition(blocks.length));
        }
        
        return button;
    }

    function setupDragAndDrop(blockElement, block, index) {
        blockElement.draggable = true;
        
        // Drag start
        blockElement.addEventListener('dragstart', (e) => {
            draggedElement = blockElement;
            blockElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', blockElement.outerHTML);
            
            // Create drop zones
            createDropZones();
        });
        
        // Drag end
        blockElement.addEventListener('dragend', (e) => {
            blockElement.classList.remove('dragging');
            draggedElement = null;
            removeDropZones();
        });
        
        // Allow drop
        blockElement.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        // Handle drop
        blockElement.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedElement && draggedElement !== blockElement) {
                handleBlockReorder(draggedElement, blockElement);
            }
        });
    }

    function createDropZones() {
        const grid = document.getElementById('dashboard-grid');
        const blockElements = grid.querySelectorAll('.dashboard-block');
        
        // Clear existing drop zones
        removeDropZones();
        
        blockElements.forEach((blockEl, index) => {
            const dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.innerHTML = '<div style="text-align: center; padding: 1rem; font-size: 12px; color: #6b7280;">Drop here</div>';
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement) {
                    handleBlockReorderToPosition(draggedElement, index);
                }
                dropZone.classList.remove('active');
            });
            
            grid.insertBefore(dropZone, blockEl);
            dropZones.push(dropZone);
        });
        
        // Add drop zone at the end
        const lastDropZone = document.createElement('div');
        lastDropZone.className = 'drop-zone';
        lastDropZone.innerHTML = '<div style="text-align: center; padding: 1rem; font-size: 12px; color: #6b7280;">Drop at end</div>';
        
        lastDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            lastDropZone.classList.add('active');
        });
        
        lastDropZone.addEventListener('dragleave', () => {
            lastDropZone.classList.remove('active');
        });
        
        lastDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedElement) {
                handleBlockReorderToPosition(draggedElement, blocks.length - 1);
            }
            lastDropZone.classList.remove('active');
        });
        
        grid.appendChild(lastDropZone);
        dropZones.push(lastDropZone);
    }

    function removeDropZones() {
        dropZones.forEach(zone => {
            if (zone.parentNode) {
                zone.parentNode.removeChild(zone);
            }
        });
        dropZones = [];
    }

    async function handleBlockReorder(draggedEl, targetEl) {
        const draggedId = draggedEl.id.replace('block-', '');
        const targetId = targetEl.id.replace('block-', '');
        
        const draggedBlock = blocks.find(b => b.id === draggedId);
        const targetBlock = blocks.find(b => b.id === targetId);
        
        if (!draggedBlock || !targetBlock) return;
        
        try {
            // Update position in database
            await updateBlock(draggedId, { position: targetBlock.position });
            
            // Update local state
            const draggedIndex = blocks.findIndex(b => b.id === draggedId);
            const targetIndex = blocks.findIndex(b => b.id === targetId);
            
            // Reorder blocks array
            const [movedBlock] = blocks.splice(draggedIndex, 1);
            blocks.splice(targetIndex, 0, movedBlock);
            
            // Update positions
            blocks.forEach((block, index) => {
                block.position = index;
            });
            
            renderDashboard();
            showToast('Block reordered successfully!');
            
        } catch (error) {
            showToast('Failed to reorder blocks', 'error');
        }
    }

    async function handleBlockReorderToPosition(draggedEl, newPosition) {
        const draggedId = draggedEl.id.replace('block-', '');
        const draggedBlock = blocks.find(b => b.id === draggedId);
        
        if (!draggedBlock) return;
        
        try {
            // Update position in database
            await updateBlock(draggedId, { position: newPosition });
            
            // Update local state
            const draggedIndex = blocks.findIndex(b => b.id === draggedId);
            const [movedBlock] = blocks.splice(draggedIndex, 1);
            blocks.splice(newPosition, 0, movedBlock);
            
            // Update positions
            blocks.forEach((block, index) => {
                block.position = index;
            });
            
            renderDashboard();
            showToast('Block moved successfully!');
            
        } catch (error) {
            showToast('Failed to move block', 'error');
        }
    }

    function createBlockElement(block) {
        const blockDiv = document.createElement('div');
        const hasDescription = block.description && block.description.trim() && block.description !== 'Block description';
        
        blockDiv.className = `dashboard-block bg-white rounded-lg shadow-sm border border-gray-200 p-4 block-${block.size} relative ${hasDescription ? 'block-has-description' : ''}`;
        blockDiv.id = `block-${block.id}`;
        
        // Block header
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-3';
        
        const titleInput = document.createElement('input');
        titleInput.type = 'text';
        titleInput.value = block.title || 'Untitled Block';
        titleInput.className = 'text-sm font-semibold text-gray-800 bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-indigo-500 rounded px-2 py-1';
        titleInput.addEventListener('blur', (e) => updateBlockTitle(block.id, e.target.value));
        
        const controls = document.createElement('div');
        controls.className = 'block-controls flex items-center space-x-2';
        
        // Description Toggle Button (individual block)
        const descToggleBtn = document.createElement('button');
        descToggleBtn.className = `description-toggle text-gray-500 hover:text-indigo-600 p-1 transition-colors ${hasDescription && descriptionsVisible ? 'active' : ''}`;
        descToggleBtn.innerHTML = '<i class="fas fa-align-left text-xs"></i>';
        descToggleBtn.title = 'Toggle description';
        descToggleBtn.addEventListener('click', () => toggleBlockDescription(block.id));
        controls.appendChild(descToggleBtn);
        
        // Drag Handle (always visible on hover)
        const dragHandle = document.createElement('button');
        dragHandle.className = 'drag-handle text-gray-400 hover:text-gray-600 p-1 transition-colors';
        dragHandle.innerHTML = '<i class="fas fa-grip-vertical text-xs"></i>';
        dragHandle.title = 'Drag to reorder';
        dragHandle.addEventListener('mousedown', (e) => {
            // Initiate drag on the parent block
            e.preventDefault();
            blockDiv.draggable = true;
        });
        controls.appendChild(dragHandle);
        
        // AI Toggle Button (only show for blocks with content)
        if (block.content && block.content.trim()) {
            const aiToggleBtn = document.createElement('button');
            aiToggleBtn.className = 'ai-toggle-button text-white p-1.5 rounded-md text-xs';
            aiToggleBtn.innerHTML = '<i class="fas fa-robot"></i>';
            aiToggleBtn.title = 'Ask AI about this chart';
            aiToggleBtn.id = `ai-toggle-${block.id}`;
            aiToggleBtn.addEventListener('click', () => toggleAIInput(block.id));
            controls.appendChild(aiToggleBtn);
        }
        
        // Edit Block Button
        const editBtn = document.createElement('button');
        editBtn.className = 'text-gray-500 hover:text-indigo-600 p-1 transition-colors';
        editBtn.innerHTML = '<i class="fas fa-edit text-xs"></i>';
        editBtn.title = 'Edit block';
        editBtn.addEventListener('click', () => editBlock(block.id));
        controls.appendChild(editBtn);
        
        // Size selector
        const sizeSelect = document.createElement('select');
        sizeSelect.className = 'text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500';
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i}/${12}`;
            if (i === block.size) option.selected = true;
            sizeSelect.appendChild(option);
        }
        sizeSelect.addEventListener('change', (e) => updateBlockSize(block.id, parseInt(e.target.value)));
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-red-500 hover:text-red-700 p-1';
        deleteBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
        deleteBtn.addEventListener('click', () => handleDeleteBlock(block.id));
        
        controls.appendChild(sizeSelect);
        controls.appendChild(deleteBtn);
        
        header.appendChild(titleInput);
        header.appendChild(controls);
        blockDiv.appendChild(header);
        
        // Block content
        const content = document.createElement('div');
        content.className = 'block-content';
        
        if (block.type === 'ai') {
            content.appendChild(createAIBlock(block));
        } else if (block.type === 'text') {
            content.appendChild(createTextBlock(block));
        } else if (block.type === 'chart') {
            content.appendChild(createChartBlock(block));
        }
        
        blockDiv.appendChild(content);
        
        // Add inline description section
        const descriptionSection = document.createElement('div');
        descriptionSection.className = 'description-section';
        
        if (hasDescription) {
            // Create editable description display
            const descriptionDiv = document.createElement('div');
            descriptionDiv.className = `block-description ${descriptionsVisible ? '' : 'hidden'}`;
            descriptionDiv.id = `desc-display-${block.id}`;
            descriptionDiv.textContent = block.description;
            descriptionDiv.addEventListener('click', () => editDescriptionInline(block.id));
            descriptionSection.appendChild(descriptionDiv);
            
            // Create editable textarea (hidden by default)
            const descriptionInput = document.createElement('textarea');
            descriptionInput.className = 'block-description-input hidden';
            descriptionInput.id = `desc-input-${block.id}`;
            descriptionInput.value = block.description;
            descriptionInput.rows = 2;
            descriptionInput.addEventListener('blur', (e) => saveDescriptionInline(block.id, e.target.value));
            descriptionInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveDescriptionInline(block.id, e.target.value);
                }
                if (e.key === 'Escape') {
                    cancelDescriptionEdit(block.id);
                }
            });
            descriptionSection.appendChild(descriptionInput);
        } else {
            // Create placeholder for adding description
            const descriptionPlaceholder = document.createElement('div');
            descriptionPlaceholder.className = `block-description ${descriptionsVisible ? '' : 'hidden'}`;
            descriptionPlaceholder.id = `desc-display-${block.id}`;
            descriptionPlaceholder.innerHTML = '<em style="color: #94a3b8;">Click to add description...</em>';
            descriptionPlaceholder.addEventListener('click', () => editDescriptionInline(block.id));
            descriptionSection.appendChild(descriptionPlaceholder);
            
            // Create editable textarea (hidden by default)
            const descriptionInput = document.createElement('textarea');
            descriptionInput.className = 'block-description-input hidden';
            descriptionInput.id = `desc-input-${block.id}`;
            descriptionInput.placeholder = 'Describe what this block shows...';
            descriptionInput.rows = 2;
            descriptionInput.addEventListener('blur', (e) => saveDescriptionInline(block.id, e.target.value));
            descriptionInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveDescriptionInline(block.id, e.target.value);
                }
                if (e.key === 'Escape') {
                    cancelDescriptionEdit(block.id);
                }
            });
            descriptionSection.appendChild(descriptionInput);
        }
        
        blockDiv.appendChild(descriptionSection);
        
        return blockDiv;
    }

    function createAIBlock(block) {
        const container = document.createElement('div');
        const hasContent = block.content && block.content.trim();
        
        // AI Input Container
        const aiInputContainer = document.createElement('div');
        aiInputContainer.className = 'ai-input-container';
        
        if (!hasContent) {
            // Show full input for new blocks without content
            const aiInputSection = document.createElement('div');
            aiInputSection.className = 'ai-input-section ai-input-full';
            aiInputSection.id = `ai-input-section-${block.id}`;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'ai-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-3';
            input.placeholder = dataSources.length > 0 ? 
                'Ask AI about your data (e.g., "show sales by month")' : 
                'Add a data source first to use AI visualization';
            input.value = block.query || '';
            input.disabled = dataSources.length === 0;
            input.id = `ai-input-${block.id}`;
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    handleAIQuery(block.id, e.target.value);
                }
            });
            
            aiInputSection.appendChild(input);
            aiInputContainer.appendChild(aiInputSection);
        } else {
            // Show compact toggle input for blocks with content
            const aiInputSection = document.createElement('div');
            aiInputSection.className = 'ai-input-section ai-input-compact collapsed';
            aiInputSection.id = `ai-input-section-${block.id}`;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'ai-input px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm';
            input.placeholder = 'Ask AI to modify this chart...';
            input.value = '';
            input.disabled = dataSources.length === 0;
            input.id = `ai-input-${block.id}`;
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    handleAIQuery(block.id, e.target.value);
                    toggleAIInput(block.id); // Hide after sending
                }
            });
            
            // Action buttons for compact input
            const actions = document.createElement('div');
            actions.className = 'ai-actions';
            
            const askBtn = document.createElement('button');
            askBtn.className = 'px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700';
            askBtn.textContent = 'Ask';
            askBtn.addEventListener('click', () => {
                const inputValue = input.value.trim();
                if (inputValue) {
                    handleAIQuery(block.id, inputValue);
                    toggleAIInput(block.id);
                }
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'px-2 py-1 text-gray-600 border border-gray-300 rounded text-xs hover:bg-gray-50';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', () => toggleAIInput(block.id));
            
            actions.appendChild(askBtn);
            actions.appendChild(cancelBtn);
            
            aiInputSection.appendChild(input);
            aiInputSection.appendChild(actions);
            aiInputContainer.appendChild(aiInputSection);
        }
        
        container.appendChild(aiInputContainer);
        
        // Show warning if no data sources
        if (dataSources.length === 0) {
            const warning = document.createElement('div');
            warning.className = 'bg-yellow-50 border border-yellow-200 rounded-md p-3 text-sm text-yellow-800';
            warning.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Add a data source to enable AI visualizations';
            container.appendChild(warning);
        }
        
        // Render chart if content exists
        if (hasContent) {
            try {
                const chartConfig = typeof block.content === 'string' ? JSON.parse(block.content) : block.content;
                const chartDiv = document.createElement('div');
                chartDiv.className = 'mt-4';
                chartDiv.id = `chart-container-${block.id}`;
                container.appendChild(chartDiv);
                Highcharts.chart(chartDiv, chartConfig);
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border border-red-200 rounded-md p-3 text-sm text-red-800 mt-4';
                errorDiv.textContent = 'Error rendering chart: ' + error.message;
                container.appendChild(errorDiv);
            }
        }
        
        return container;
    }

    function createTextBlock(block) {
        const textarea = document.createElement('textarea');
        textarea.className = 'w-full h-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none';
        textarea.placeholder = 'Enter your text...';
        textarea.value = block.content || '';
        
        textarea.addEventListener('blur', (e) => updateBlockContent(block.id, e.target.value));
        
        return textarea;
    }

    function createChartBlock(block) {
        const container = document.createElement('div');
        
        if (block.content) {
            try {
                const chartConfig = typeof block.content === 'string' ? JSON.parse(block.content) : block.content;
                Highcharts.chart(container, chartConfig);
            } catch (error) {
                container.className = 'bg-red-50 border border-red-200 rounded-md p-3 text-sm text-red-800';
                container.textContent = 'Error rendering chart: ' + error.message;
            }
        } else {
            container.className = 'bg-gray-50 border border-gray-200 rounded-md p-8 text-center text-gray-500';
            container.textContent = 'Chart content will appear here';
        }
        
        return container;
    }

    function renderDataSources() {
        const container = document.getElementById('data-sources-list');
        
        container.innerHTML = '';
        
        if (!dataSources || dataSources.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'text-center py-8 text-gray-500';
            emptyState.innerHTML = `
                <i class="fas fa-database text-3xl mb-4 opacity-50"></i>
                <p class="text-sm">No data sources yet</p>
                <p class="text-xs mt-1">Add data to enable AI visualizations</p>
                <button onclick="openDataSourceModal()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                    <i class="fas fa-plus mr-2"></i>Add Data Source
                </button>
            `;
            container.appendChild(emptyState);
            return;
        }
        
        dataSources.forEach(source => {
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'bg-gray-50 rounded-lg p-3 mb-3 border border-gray-200';
            
            const icon = source.file_name ? 'fas fa-file' : 'fas fa-database';
            const iconColor = source.file_name?.endsWith('.csv') ? 'text-green-600' : 
                              source.title.toLowerCase().includes('synthetic') ? 'text-purple-600' : 'text-blue-600';
            
            sourceDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="${icon} ${iconColor} mr-2"></i>
                        <div>
                            <div class="text-sm font-medium text-gray-800">${source.title}</div>
                            ${source.file_name ? `<div class="text-xs text-gray-500">${source.file_name}</div>` : 
                              source.title.toLowerCase().includes('synthetic') ? '<div class="text-xs text-purple-600">AI Generated</div>' : ''}
                        </div>
                    </div>
                    <button onclick="deleteDataSource('${source.id}')" class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(sourceDiv);
        });
        
        // Add button at bottom
        const addButton = document.createElement('button');
        addButton.className = 'w-full mt-4 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-indigo-500 hover:text-indigo-500 transition-colors';
        addButton.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Another Data Source';
        addButton.addEventListener('click', openDataSourceModal);
        container.appendChild(addButton);
    }

    // Event handlers
    async function addBlock(type = 'ai') {
        await addBlockAtPosition(blocks.length, type);
    }

    async function addBlockAtPosition(position, type = 'ai') {
        if (!currentDashboard) return;
        
        try {
            showLoading();
            const blockData = {
                title: 'New Block',
                description: '',
                type: type,
                size: 4,
                content: '',
                position: position
            };
            
            const newBlock = await createBlock(currentDashboard.id, blockData);
            
            // Insert block at the correct position in local array
            if (position === 0) {
                blocks.unshift(newBlock);
            } else if (position >= blocks.length) {
                blocks.push(newBlock);
            } else {
                blocks.splice(position, 0, newBlock);
            }
            
            // Update positions for all blocks
            blocks.forEach((block, index) => {
                block.position = index;
            });
            
            renderDashboard(true);
            showToast('Block added successfully!');
        } catch (error) {
            handleApiError(error, 'Failed to add block');
        } finally {
            hideLoading();
        }
    }

    async function updateBlockTitle(blockId, title) {
        try {
            await updateBlock(blockId, { title });
            
            // Update local state
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].title = title;
            }
            
            showSaveStatus();
        } catch (error) {
            handleApiError(error, 'Failed to update block title');
        }
    }

    async function updateBlockContent(blockId, content) {
        try {
            await updateBlock(blockId, { content });
            
            // Update local state
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].content = content;
            }
            
            showSaveStatus();
        } catch (error) {
            handleApiError(error, 'Failed to update block content');
        }
    }

    async function updateBlockSize(blockId, size) {
        try {
            showLoading();
            await updateBlock(blockId, { size });
            
            // Update local state
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].size = size;
            }
            
            renderDashboard();
            showSaveStatus();
        } catch (error) {
            handleApiError(error, 'Failed to resize block');
        } finally {
            hideLoading();
        }
    }

    let currentEditingBlockId = null;

    async function updateBlockTitleAndDescription(blockId, title, description) {
        try {
            await updateBlock(blockId, { title, description });
            
            // Update local state
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].title = title;
                blocks[blockIndex].description = description;
            }
            
            // Re-render the dashboard to update tooltips and visual indicators
            renderDashboard();
            showSaveStatus();
        } catch (error) {
            handleApiError(error, 'Failed to update block');
            throw error;
        }
    }

    function editBlock(blockId) {
        const block = blocks.find(b => b.id === blockId);
        if (!block) return;
        
        currentEditingBlockId = blockId;
        
        // Set current values in the modal
        document.getElementById('block-title-input').value = block.title || '';
        document.getElementById('block-description-input').value = block.description || '';
        
        // Update preview
        updateTooltipPreview();
        
        // Show the modal
        document.getElementById('edit-block-modal').classList.remove('hidden');
    }

    function closeBlockEditModal() {
        document.getElementById('edit-block-modal').classList.add('hidden');
        currentEditingBlockId = null;
        document.getElementById('edit-block-form').reset();
        document.getElementById('tooltip-preview').classList.add('hidden');
    }

    function updateTooltipPreview() {
        const description = document.getElementById('block-description-input').value.trim();
        const preview = document.getElementById('tooltip-preview');
        const previewText = document.getElementById('preview-text');
        
        if (description) {
            previewText.textContent = description;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    }

    async function handleBlockUpdate(event) {
        event.preventDefault();
        
        if (!currentEditingBlockId) return;
        
        const title = document.getElementById('block-title-input').value.trim();
        const description = document.getElementById('block-description-input').value.trim();
        
        if (!title) {
            showToast('Block title is required', 'error');
            return;
        }
        
        const saveBtn = document.getElementById('save-block-changes');
        const btnText = saveBtn.querySelector('.btn-text');
        const spinner = saveBtn.querySelector('.spinner');
        
        try {
            // Show loading state
            saveBtn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('hidden');
            
            await updateBlockTitleAndDescription(currentEditingBlockId, title, description);
            
            closeBlockEditModal();
            showToast('Block updated successfully!');
            
        } catch (error) {
            showToast('Failed to update block', 'error');
        } finally {
            // Reset button state
            saveBtn.disabled = false;
            btnText.textContent = 'Save Changes';
            spinner.classList.add('hidden');
        }
    }

    async function handleDeleteBlock(blockId) {
        if (!confirm('Are you sure you want to delete this block?')) return;
        
        try {
            showLoading();
            await deleteBlock(blockId);
            
            // Remove from local state
            blocks = blocks.filter(b => b.id !== blockId);
            renderDashboard();
            showToast('Block deleted successfully!');
        } catch (error) {
            handleApiError(error, 'Failed to delete block');
        } finally {
            hideLoading();
        }
    }

    async function handleAIQuery(blockId, query) {
        try {
            // Set processing state for AI button if it exists
            setAIButtonProcessing(blockId, true);
            
            showLoading();
            const result = await askAI(query, blockId, currentDashboard.id);
            
            // Update block content
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex !== -1) {
                blocks[blockIndex].content = JSON.stringify(result);
                blocks[blockIndex].query = query;
            }
            
            renderDashboard();
            showToast('AI visualization created!');
            
        } catch (error) {
            handleApiError(error, 'Failed to generate AI visualization');
        } finally {
            hideLoading();
            // Reset processing state
            setAIButtonProcessing(blockId, false);
        }
    }

    async function handleUpdateDashboard(field, value) {
        if (!currentDashboard) return;
        
        try {
            await updateDashboard(currentDashboard.id, { [field]: value });
            showSaveStatus();
        } catch (error) {
            handleApiError(error, `Failed to update dashboard ${field}`);
        }
    }

    // Modal functions
    function openDataSourceModal() {
        document.getElementById('add-datasource-modal').classList.remove('hidden');
        // Reset form state
        generatedSyntheticData = null;
        document.getElementById('synthetic-preview-container').classList.add('hidden');
        document.getElementById('synthetic-instructions').value = '';
    }

    function closeDataSourceModal() {
        document.getElementById('add-datasource-modal').classList.add('hidden');
        document.getElementById('add-datasource-form').reset();
        generatedSyntheticData = null;
        document.getElementById('synthetic-preview-container').classList.add('hidden');
        
        // Reset to first option
        document.querySelectorAll('.input-method-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector('.input-method-card').classList.add('selected');
        document.querySelector('input[name="input-method"][value="text"]').checked = true;
        toggleInputMethod();
    }

    async function handleAddDataSource(event) {
        event.preventDefault();
        
        const method = document.querySelector('input[name="input-method"]:checked').value;
        const title = document.getElementById('datasource-title').value;
        
        if (!title) {
            showToast('Title is required', 'error');
            return;
        }
        
        try {
            showLoading();
            
            let formData = new FormData();
            formData.append('title', title);
            
            if (method === 'synthetic') {
                // Use the generated synthetic data
                if (!generatedSyntheticData) {
                    showToast('Please generate synthetic data first', 'error');
                    hideLoading();
                    return;
                }
                
                // Get the edited data from the preview textarea
                const editedData = document.getElementById('synthetic-data-preview').value;
                
                try {
                    // Validate JSON
                    JSON.parse(editedData);
                    formData.append('content', editedData);
                } catch (error) {
                    showToast('Invalid JSON data in preview. Please fix the format.', 'error');
                    hideLoading();
                    return;
                }
            } else if (method === 'file') {
                const fileInput = document.getElementById('datasource-file');
                if (!fileInput.files[0]) {
                    showToast('Please select a file', 'error');
                    hideLoading();
                    return;
                }
                formData.append('file', fileInput.files[0]);
            } else {
                const content = document.getElementById('datasource-content').value;
                if (!content) {
                    showToast('Content is required', 'error');
                    hideLoading();
                    return;
                }
                formData.append('content', content);
            }
            
            const newDataSource = await createDataSource(currentDashboard.id, formData);
            dataSources.push(newDataSource);
            renderDataSources();
            closeDataSourceModal();
            showToast('Data source added successfully!');
            
            // Re-render dashboard to update AI blocks
            renderDashboard();
            
        } catch (error) {
            handleApiError(error, 'Failed to add data source');
        } finally {
            hideLoading();
        }
    }

    async function deleteDataSource(sourceId) {
        if (!confirm('Are you sure you want to delete this data source?')) return;
        
        try {
            showLoading();
            const response = await fetch(`${API_BASE_DASHBOARD}/datasources/${sourceId}`, {
                method: 'DELETE'
            });
            
            const result = await handleApiResponse(response);
            
            dataSources = dataSources.filter(ds => ds.id !== sourceId);
            renderDataSources();
            renderDashboard(); // Re-render to update AI blocks
            showToast('Data source deleted successfully!');
        } catch (error) {
            handleApiError(error, 'Failed to delete data source');
        } finally {
            hideLoading();
        }
    }

    // Toolbar drag functionality
    function initializeToolbarDrag() {
        const toolbar = document.getElementById('floating-toolbar');
        const dragHandle = document.getElementById('toolbar-drag-handle');
        let isDragging = false;
        let startX, startY, startLeft, startBottom;

        dragHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            toolbar.classList.add('dragging');
            
            const rect = toolbar.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startLeft = rect.left;
            startBottom = window.innerHeight - rect.bottom;
            
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            const newLeft = startLeft + deltaX;
            const newBottom = startBottom - deltaY;
            
            // Keep toolbar within viewport
            const maxLeft = window.innerWidth - toolbar.offsetWidth;
            const maxBottom = window.innerHeight - toolbar.offsetHeight;
            
            const constrainedLeft = Math.max(0, Math.min(newLeft, maxLeft));
            const constrainedBottom = Math.max(20, Math.min(newBottom, maxBottom));
            
            toolbar.style.left = constrainedLeft + 'px';
            toolbar.style.bottom = constrainedBottom + 'px';
            toolbar.style.transform = 'none';
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                toolbar.classList.remove('dragging');
            }
        });
    }

    // Initialize dashboard view
    async function initializeDashboardView() {
        const dashboardId = getDashboardIdFromUrl();
        
        if (!dashboardId) {
            document.getElementById('dashboard-loading').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            return;
        }

        try {
            // Fetch dashboard data
            console.log('Fetching dashboard data...');
            currentDashboard = await fetchDashboard(dashboardId);
            console.log('Dashboard fetched successfully:', currentDashboard);
            
            blocks = currentDashboard.blocks || [];
            dataSources = currentDashboard.datasources || [];
            console.log('Blocks:', blocks.length, 'Data sources:', dataSources.length);

            // Update UI
            renderDashboard();
            renderDataSources();

            // Update page title
            if (currentDashboard.title) {
                document.title = `${currentDashboard.title} - Snappy Learn`;
            }

            console.log('Dashboard initialization complete');

        } catch (error) {
            console.error('Failed to initialize dashboard:', error);
            document.getElementById('dashboard-loading').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            
            // Show more specific error message
            if (error.message.includes('404') || error.message.includes('not found')) {
                showToast('Dashboard not found or access denied', 'error');
            } else if (error.message.includes('403') || error.message.includes('unauthorized')) {
                showToast('Access denied to this dashboard', 'error');
            } else {
                showToast('Failed to load dashboard: ' + error.message, 'error');
            }
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard detail view DOM loaded');
        
        // Initialize dashboard
        initializeDashboardView();
        
        // Initialize toolbar drag
        initializeToolbarDrag();

        // Toolbar buttons
        document.getElementById('dashboard-info-btn')?.addEventListener('click', toggleDashboardInfo);
        document.getElementById('data-sources-btn')?.addEventListener('click', toggleDataSources);
        document.getElementById('preview-btn')?.addEventListener('click', previewDashboard);
        document.getElementById('share-btn')?.addEventListener('click', openShareModal);
        document.getElementById('smart-insights-btn')?.addEventListener('click', openSmartInsightsModal);

        // Info panel controls
        document.getElementById('close-info-panel')?.addEventListener('click', toggleDashboardInfo);
        document.getElementById('cancel-info-edit')?.addEventListener('click', toggleDashboardInfo);
        document.getElementById('save-info-edit')?.addEventListener('click', () => {
            const title = document.getElementById('dashboard-title-edit').value;
            const description = document.getElementById('dashboard-description-edit').value;
            
            if (title.trim()) {
                handleUpdateDashboard('title', title);
                currentDashboard.title = title;
            }
            if (description.trim()) {
                handleUpdateDashboard('description', description);
                currentDashboard.description = description;
            }
            
            showToast('Dashboard info saved!');
            showSaveStatus();
            toggleDashboardInfo();
        });

        // Data sources sidebar
        document.getElementById('close-data-sources')?.addEventListener('click', toggleDataSources);
        document.getElementById('sidebar-backdrop')?.addEventListener('click', toggleDataSources);

        // Share modal controls
        document.getElementById('close-share-modal')?.addEventListener('click', closeShareModal);
        document.getElementById('copy-link-btn')?.addEventListener('click', copyShareLink);
        document.getElementById('share-email')?.addEventListener('click', shareViaEmail);
        document.getElementById('share-social')?.addEventListener('click', shareViaSocial);
        document.getElementById('show-qr-btn')?.addEventListener('click', toggleQRCode);

        // Smart Insights Modal Events
        document.getElementById('close-insights-modal')?.addEventListener('click', closeInsightsModal);
        document.getElementById('generate-insights-btn')?.addEventListener('click', generateSmartInsights);
        document.getElementById('regenerate-insights-btn')?.addEventListener('click', regenerateInsights);
        document.getElementById('save-all-insights-btn')?.addEventListener('click', saveAllInsights);
        document.getElementById('generate-more-insights-btn')?.addEventListener('click', generateMoreInsights);

        // Data source modal controls
        document.getElementById('close-datasource-modal')?.addEventListener('click', closeDataSourceModal);
        document.getElementById('cancel-datasource')?.addEventListener('click', closeDataSourceModal);
        document.getElementById('add-datasource-form')?.addEventListener('submit', handleAddDataSource);

        // Block edit modal
        document.getElementById('close-block-edit-modal')?.addEventListener('click', closeBlockEditModal);
        document.getElementById('cancel-block-edit')?.addEventListener('click', closeBlockEditModal);
        document.getElementById('edit-block-form')?.addEventListener('submit', handleBlockUpdate);

        // Live preview for description
        document.getElementById('block-description-input')?.addEventListener('input', updateTooltipPreview);

        // Synthetic data generation
        document.getElementById('generate-synthetic-btn')?.addEventListener('click', generateSyntheticData);
        document.getElementById('regenerate-synthetic-btn')?.addEventListener('click', regenerateSyntheticData);

        // Input method toggle
        document.querySelectorAll('.input-method-card').forEach(card => {
            card.addEventListener('click', function() {
                const method = this.querySelector('input[name="input-method"]').value;
                selectInputMethod(method);
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const shareModal = document.getElementById('share-modal');
            const dataSourceModal = document.getElementById('add-datasource-modal');
            const insightsModal = document.getElementById('smart-insights-modal');
            const blockEditModal = document.getElementById('edit-block-modal');
            
            if (event.target === shareModal) {
                closeShareModal();
            }
            
            if (event.target === dataSourceModal) {
                closeDataSourceModal();
            }
            
            if (event.target === insightsModal) {
                closeInsightsModal();
            }
            
            if (event.target === blockEditModal) {
                closeBlockEditModal();
            }
        });

        // Handle modal close and dashboard refresh
        window.addEventListener('beforeunload', function() {
            // Refresh dashboard if insights were saved
            if (savedInsightIds.size > 0) {
                renderDashboard();
            }
        });
    });

    console.log('Dashboard detail view script loaded');
</script>