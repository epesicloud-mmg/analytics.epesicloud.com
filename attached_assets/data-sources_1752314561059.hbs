<!-- Complete Data Sources View Page -->

<style>
    /* Data source-specific styles */
    .datasource-card {
        transition: all 0.2s ease;
    }
    .datasource-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .project-badge {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    
    .project-badge-blue { background-color: #3b82f6; }
    .project-badge-green { background-color: #10b981; }
    .project-badge-purple { background-color: #8b5cf6; }
    .project-badge-orange { background-color: #f59e0b; }
    .project-badge-pink { background-color: #ec4899; }
    .project-badge-indigo { background-color: #6366f1; }
    .project-badge-red { background-color: #ef4444; }
    .project-badge-yellow { background-color: #eab308; }
    .project-badge-teal { background-color: #14b8a6; }
    .project-badge-gray { background-color: #6b7280; }
    
    /* File type icons */
    .file-type-csv { color: #10b981; }
    .file-type-json { color: #3b82f6; }
    .file-type-xlsx { color: #059669; }
    .file-type-api { color: #8b5cf6; }
    .file-type-database { color: #dc2626; }
    .file-type-other { color: #6b7280; }
    
    /* Grid and List views */
    .datasources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    
    .datasources-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    /* Data source Item */
    .datasource-item {
        transition: all 0.2s ease-in-out;
        position: relative;
    }
    
    .datasource-item:hover {
        transform: translateY(-2px);
    }
    
    .datasource-item-menu {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.2s ease-in-out;
    }
    
    .datasource-item:hover .datasource-item-menu {
        visibility: visible;
        opacity: 1;
    }

    /* View toggle */
    .view-active {
        background-color: #ddd6fe;
        color: #5b21b6;
    }

    .view-inactive {
        background-color: white;
        color: #6b7280;
    }

    /* Connection status */
    .status-connected { color: #10b981; }
    .status-disconnected { color: #dc2626; }
    .status-pending { color: #f59e0b; }

    /* File size formatting */
    .file-size {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.75rem;
    }
</style>

<!-- Loading State for entire page -->
<div id="page-loading" class="flex justify-center items-center h-64">
    <div class="flex items-center space-x-2">
        <i class="fas fa-spinner animate-spin text-purple-600 text-xl"></i>
        <span class="text-gray-600">Loading data sources...</span>
    </div>
</div>

<!-- Error State -->
<div id="error-state" class="hidden text-center py-12">
    <div class="h-24 w-24 bg-red-100 mx-auto rounded-full flex items-center justify-center mb-4">
        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to Load Data Sources</h3>
    <p class="text-gray-500 mb-4">There was an error loading your data sources. Please try again.</p>
    <button onclick="DataSourcesView.retry()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
        <i class="fas fa-refresh mr-2"></i>
        Retry
    </button>
</div>

<!-- Main Content Container -->
<div id="main-content" class="hidden">
    <!-- Data Sources Header -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Data Sources</h1>
                <p id="datasources-subtitle" class="text-sm text-gray-500 mt-1">Manage your data connections and files</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex flex-wrap items-center space-x-3">
                <!-- View Toggle -->
                <div class="flex rounded-md shadow-sm">
                    <button id="grid-view" class="view-active px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-md focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                        <i class="fas fa-th-large mr-1"></i> Grid
                    </button>
                    <button id="list-view" class="view-inactive px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-md hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500">
                        <i class="fas fa-list mr-1"></i> List
                    </button>
                </div>
                
                <!-- Sort Dropdown -->
                <div class="relative">
                    <select id="sort-datasources" class="inline-flex items-center px-4 py-2 border border-gray-200 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <option value="created_at_desc">Newest First</option>
                        <option value="created_at_asc">Oldest First</option>
                        <option value="title_asc">Name A-Z</option>
                        <option value="title_desc">Name Z-A</option>
                        <option value="file_type_asc">File Type</option>
                        <option value="project_name_asc">Project A-Z</option>
                    </select>
                </div>
                
                <!-- Upload Data Source -->
                <button onclick="DataSourcesView.uploadDataSource()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-upload mr-2"></i>
                    Upload Data
                </button>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div class="flex flex-wrap items-center space-x-4">
                <!-- Search Filter -->
                <div class="relative w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400 text-sm"></i>
                    </div>
                    <input 
                        id="datasource-search"
                        type="text" 
                        class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm text-gray-600 placeholder-gray-400" 
                        placeholder="Search data sources..."
                    >
                </div>
                
                <!-- Project Filter -->
                <div class="relative">
                    <select id="project-filter" class="px-3 py-2 border border-gray-200 rounded-md text-sm text-gray-600 focus:ring-purple-500 focus:border-purple-500">
                        <option value="all">All Projects</option>
                        <!-- Projects will be populated here -->
                    </select>
                </div>
                
                <!-- File Type Filter -->
                <div class="relative">
                    <select id="filetype-filter" class="px-3 py-2 border border-gray-200 rounded-md text-sm text-gray-600 focus:ring-purple-500 focus:border-purple-500">
                        <option value="all">All Types</option>
                        <option value="csv">CSV Files</option>
                        <option value="json">JSON Files</option>
                        <option value="xlsx">Excel Files</option>
                        <option value="api">API Connections</option>
                        <option value="database">Databases</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="relative">
                    <select id="status-filter" class="px-3 py-2 border border-gray-200 rounded-md text-sm text-gray-600 focus:ring-purple-500 focus:border-purple-500">
                        <option value="all">All Status</option>
                        <option value="connected">Connected</option>
                        <option value="disconnected">Disconnected</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 text-sm text-gray-500">
                <span id="datasources-count">0 data sources</span>
                <span>•</span>
                <button id="clear-filters" class="text-purple-600 hover:text-purple-800 font-medium">Clear filters</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Data Sources -->
    <div id="loading-datasources" class="hidden flex justify-center items-center p-8">
        <div class="flex items-center space-x-2">
            <i class="fas fa-spinner animate-spin text-purple-600 text-xl"></i>
            <span class="text-gray-600">Loading data sources...</span>
        </div>
    </div>
    
    <!-- Data Sources Container -->
    <div id="datasources-container" class="datasources-grid">
        <!-- Data sources will be populated here -->
    </div>
    
    <!-- Empty State -->
    <div id="datasources-empty" class="hidden text-center py-12">
        <div class="h-24 w-24 bg-gray-100 mx-auto rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-database text-gray-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No data sources found</h3>
        <p class="text-gray-500 mb-4">Upload your first data file or connect to a data source</p>
        <button onclick="DataSourcesView.uploadDataSource()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
            <i class="fas fa-upload mr-2"></i>
            Upload Data
        </button>
    </div>
</div>

<!-- Data Source Menu Dropdown (for actions) -->
<div id="datasource-menu" class="hidden absolute z-10 mt-1 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5">
    <div class="py-1">
        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="preview">
            <i class="fas fa-eye mr-2"></i> Preview Data
        </a>
        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="download">
            <i class="fas fa-download mr-2"></i> Download
        </a>
        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="duplicate">
            <i class="fas fa-copy mr-2"></i> Duplicate
        </a>
        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="refresh">
            <i class="fas fa-sync mr-2"></i> Refresh Data
        </a>
        <hr class="my-1">
        <a href="#" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50" data-action="delete">
            <i class="fas fa-trash mr-2"></i> Delete
        </a>
    </div>
</div>

<!-- Upload Data Source Modal -->
<div id="upload-datasource-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-lg font-medium text-gray-900">Upload Data Source</h3>
            <button id="close-upload-modal" class="p-1 rounded-md hover:bg-gray-100 focus:outline-none">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="mt-4">
            <form id="upload-datasource-form" enctype="multipart/form-data">
                <div class="mb-4">
                    <label for="datasource-project" class="block text-sm font-medium text-gray-700 mb-1">Project <span class="text-red-500">*</span></label>
                    <select 
                        id="datasource-project" 
                        name="project_id"
                        required
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                    >
                        <option value="">Select a project...</option>
                        <!-- Projects will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="datasource-title" class="block text-sm font-medium text-gray-700 mb-1">Data Source Name <span class="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        id="datasource-title" 
                        name="title"
                        required
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" 
                        placeholder="Enter data source name"
                    >
                </div>
                
                <div class="mb-4">
                    <label for="datasource-file" class="block text-sm font-medium text-gray-700 mb-1">File <span class="text-red-500">*</span></label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-purple-400 transition-colors">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                            <div class="flex text-sm text-gray-600">
                                <label for="datasource-file" class="relative cursor-pointer bg-white rounded-md font-medium text-purple-600 hover:text-purple-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-purple-500">
                                    <span>Upload a file</span>
                                    <input id="datasource-file" name="file" type="file" accept=".csv,.json,.xlsx,.xls" class="sr-only" required>
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">CSV, JSON, Excel up to 10MB</p>
                            <div id="file-info" class="hidden mt-2 text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-upload" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Cancel
                    </button>
                    <button type="submit" id="upload-submit" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-purple-600 border border-transparent rounded-md shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <span class="btn-text">Upload Data Source</span>
                        <i class="fas fa-spinner animate-spin ml-2 hidden" id="upload-spinner"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Data Sources View JavaScript -->
<script>
(function() {
    'use strict';
    
    // Data sources view state
    const dataSourcesState = {
        dataSources: [],
        dashboards: [],
        projects: [],
        filteredDataSources: [],
        currentView: 'grid',
        currentSort: 'created_at_desc',
        searchTerm: '',
        projectFilter: 'all',
        fileTypeFilter: 'all',
        statusFilter: 'all',
        isInitialized: false,
        activeOrganization: null
    };
    
    // Color mapping for project badges
    const projectColorMap = {
        purple: 'project-badge-purple',
        blue: 'project-badge-blue', 
        green: 'project-badge-green',
        yellow: 'project-badge-yellow',
        red: 'project-badge-red',
        pink: 'project-badge-pink',
        indigo: 'project-badge-indigo',
        teal: 'project-badge-teal',
        orange: 'project-badge-orange',
        gray: 'project-badge-gray'
    };

    // Utility functions
    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) return '1 day ago';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
        return date.toLocaleDateString();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return 'Unknown';
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getFileTypeIcon(fileType, fileName) {
        if (!fileType && !fileName) return { icon: 'fa-file', class: 'file-type-other' };
        
        const type = (fileType || '').toLowerCase();
        const name = (fileName || '').toLowerCase();
        
        if (type.includes('csv') || name.endsWith('.csv')) {
            return { icon: 'fa-file-csv', class: 'file-type-csv' };
        } else if (type.includes('json') || name.endsWith('.json')) {
            return { icon: 'fa-file-code', class: 'file-type-json' };
        } else if (type.includes('excel') || type.includes('spreadsheet') || name.endsWith('.xlsx') || name.endsWith('.xls')) {
            return { icon: 'fa-file-excel', class: 'file-type-xlsx' };
        } else if (type.includes('api')) {
            return { icon: 'fa-plug', class: 'file-type-api' };
        } else if (type.includes('database') || type.includes('sql')) {
            return { icon: 'fa-database', class: 'file-type-database' };
        } else {
            return { icon: 'fa-file', class: 'file-type-other' };
        }
    }

    function getConnectionStatus(dataSource) {
        // This would be determined by your backend logic
        // For now, we'll assume all file uploads are "connected"
        if (dataSource.file_name) {
            return { status: 'connected', text: 'Connected', class: 'status-connected' };
        }
        return { status: 'pending', text: 'Pending', class: 'status-pending' };
    }

    // API functions
    async function fetchDataSources(orgId) {
        try {
            console.log('Fetching data sources for organization:', orgId);
            
            // Get all dashboards first to get their data sources
            const dashboardsResponse = await window.SnappyLearn.apiCall(`/api/admin/organizations/${orgId}/dashboards`);
            
            if (!dashboardsResponse || !dashboardsResponse.success) {
                console.warn('Failed to fetch dashboards for data sources');
                return [];
            }
            
            const dashboards = dashboardsResponse.data || [];
            dataSourcesState.dashboards = dashboards;
            
            // Fetch data sources for each dashboard
            const allDataSources = [];
            
            for (const dashboard of dashboards) {
                try {
                    const dataSourcesResponse = await window.SnappyLearn.apiCall(`/api/dashboards/${dashboard.id}/datasources`);
                    
                    if (dataSourcesResponse && dataSourcesResponse.success && Array.isArray(dataSourcesResponse.data)) {
                        // Add dashboard and project info to each data source
                        const dataSourcesWithContext = dataSourcesResponse.data.map(ds => ({
                            ...ds,
                            dashboard_id: dashboard.id,
                            dashboard_title: dashboard.title,
                            project_id: dashboard.project_id,
                            project_name: dashboard.project_name
                        }));
                        
                        allDataSources.push(...dataSourcesWithContext);
                    }
                } catch (error) {
                    console.warn(`Failed to fetch data sources for dashboard ${dashboard.id}:`, error);
                }
            }
            
            console.log('Fetched data sources:', allDataSources.length);
            return allDataSources;
            
        } catch (error) {
            console.error('Error fetching data sources:', error);
            return [];
        }
    }

    async function fetchProjects(orgId) {
        try {
            console.log('Fetching projects for organization:', orgId);
            
            // Try SnappyLearn function first
            if (window.SnappyLearn && typeof window.SnappyLearn.loadOrganizationProjects === 'function') {
                const projects = await window.SnappyLearn.loadOrganizationProjects(orgId);
                return projects || [];
            } else {
                // Fall back to direct API call
                const response = await window.SnappyLearn.apiCall(`/api/admin/organizations/${orgId}/projects`);
                
                if (response && response.success && Array.isArray(response.data)) {
                    return response.data;
                } else {
                    console.warn('Invalid projects response, returning empty array');
                    return [];
                }
            }
        } catch (error) {
            console.error('Error fetching projects:', error);
            return [];
        }
    }

    async function uploadDataSource(projectId, formData) {
        try {
            console.log('Uploading data source for project:', projectId);
            
            // Find a dashboard in this project to upload to
            const projectDashboards = dataSourcesState.dashboards.filter(d => d.project_id === projectId);
            
            if (projectDashboards.length === 0) {
                throw new Error('No dashboards found in selected project. Create a dashboard first.');
            }
            
            // Use the first dashboard
            const dashboardId = projectDashboards[0].id;
            
            const response = await window.SnappyLearn.apiCall(`/api/dashboards/${dashboardId}/datasources`, 'POST', formData);
            
            if (response && response.success && response.data) {
                return response.data;
            } else {
                throw new Error(response?.message || 'Invalid response structure');
            }
        } catch (error) {
            console.error('Error uploading data source:', error);
            throw error;
        }
    }

    // Render functions
    function renderDataSourceCard(dataSource, index) {
        const project = dataSourcesState.projects.find(p => p.id === dataSource.project_id) || {};
        const projectColorClass = projectColorMap[project.color] || 'project-badge-indigo';
        const fileTypeInfo = getFileTypeIcon(dataSource.file_type, dataSource.file_name);
        const connectionStatus = getConnectionStatus(dataSource);
        
        return `
            <div class="datasource-item datasource-card bg-white rounded-lg shadow-sm overflow-hidden border border-transparent hover:border-purple-200" data-datasource-id="${dataSource.id}">
                <!-- Data Source Header -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas ${fileTypeInfo.icon} ${fileTypeInfo.class} text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-800 line-clamp-1">${escapeHtml(dataSource.title || 'Untitled Data Source')}</h3>
                                <p class="text-xs text-gray-500">${escapeHtml(dataSource.file_name || 'No file')}</p>
                            </div>
                        </div>
                        
                        <!-- Data Source Menu -->
                        <div class="datasource-item-menu">
                            <button class="p-1.5 rounded-full hover:bg-gray-100 focus:outline-none" onclick="DataSourcesView.showDataSourceMenu(event, '${dataSource.id}')">
                                <i class="fas fa-ellipsis-v text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Project Info -->
                    <div class="flex items-center mb-2">
                        <span class="project-badge ${projectColorClass}"></span>
                        <span class="text-xs text-gray-500">${escapeHtml(dataSource.project_name || 'Unknown Project')}</span>
                    </div>
                </div>
                
                <!-- Data Source Info -->
                <div class="p-4">
                    <!-- Connection Status -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                            ${escapeHtml(dataSource.file_type || 'Unknown Type')}
                        </span>
                        <span class="flex items-center text-xs ${connectionStatus.class}">
                            <i class="fas fa-circle mr-1" style="font-size: 6px;"></i>
                            ${connectionStatus.text}
                        </span>
                    </div>
                    
                    <!-- File Info -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-sm font-semibold text-purple-600">~</div>
                            <div class="text-xs text-gray-500">Records</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm font-semibold text-orange-600 file-size">~</div>
                            <div class="text-xs text-gray-500">Size</div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex space-x-2">
                        <button onclick="DataSourcesView.previewDataSource('${dataSource.id}')" class="flex-1 text-center px-3 py-2 text-sm font-medium text-purple-600 bg-purple-50 rounded-md hover:bg-purple-100 transition-colors">
                            <i class="fas fa-eye mr-1"></i> Preview
                        </button>
                        <button onclick="DataSourcesView.downloadDataSource('${dataSource.id}')" class="flex-1 text-center px-3 py-2 text-sm font-medium text-gray-600 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors">
                            <i class="fas fa-download mr-1"></i> Download
                        </button>
                    </div>
                    
                    <!-- Last Updated -->
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        Updated ${formatDate(dataSource.created_at)}
                    </div>
                </div>
            </div>
        `;
    }

    function renderDataSourceList(dataSource, index) {
        const project = dataSourcesState.projects.find(p => p.id === dataSource.project_id) || {};
        const projectColorClass = projectColorMap[project.color] || 'project-badge-indigo';
        const fileTypeInfo = getFileTypeIcon(dataSource.file_type, dataSource.file_name);
        const connectionStatus = getConnectionStatus(dataSource);
        
        return `
            <div class="datasource-item bg-white rounded-lg shadow-sm border border-transparent hover:border-purple-200 p-4" data-datasource-id="${dataSource.id}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <!-- Data Source Icon & Info -->
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas ${fileTypeInfo.icon} ${fileTypeInfo.class} text-sm"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-800">${escapeHtml(dataSource.title || 'Untitled Data Source')}</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="project-badge ${projectColorClass}"></span>
                                    <span class="text-xs text-gray-500">${escapeHtml(dataSource.project_name || 'Unknown Project')}</span>
                                    <span class="text-gray-300">•</span>
                                    <span class="text-xs text-gray-500">${escapeHtml(dataSource.file_name || 'No file')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Source Stats -->
                        <div class="hidden md:flex items-center space-x-6">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">${escapeHtml(dataSource.file_type || 'Unknown')}</div>
                                <div class="text-xs text-gray-400">Type</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 file-size">~</div>
                                <div class="text-xs text-gray-400">Size</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">${formatDate(dataSource.created_at)}</div>
                                <div class="text-xs text-gray-400">Created</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center space-x-2">
                        <span class="flex items-center text-xs ${connectionStatus.class}">
                            <i class="fas fa-circle mr-1" style="font-size: 6px;"></i>
                            ${connectionStatus.text}
                        </span>
                        <button onclick="DataSourcesView.previewDataSource('${dataSource.id}')" class="px-3 py-1 text-xs font-medium text-purple-600 hover:text-purple-800">
                            Preview
                        </button>
                        <button class="p-1 rounded hover:bg-gray-100 focus:outline-none" onclick="DataSourcesView.showDataSourceMenu(event, '${dataSource.id}')">
                            <i class="fas fa-ellipsis-v text-gray-500 text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderUploadDataSourceCard() {
        return `
            <div class="datasource-item bg-white rounded-lg shadow-sm border border-dashed border-gray-300 flex items-center justify-center hover:border-purple-300 cursor-pointer" onclick="DataSourcesView.uploadDataSource()">
                <div class="text-center p-8">
                    <div class="h-12 w-12 bg-purple-100 mx-auto rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-upload text-purple-600 text-lg"></i>
                    </div>
                    <h3 class="text-md font-medium text-gray-800 mb-1">Upload Data Source</h3>
                    <p class="text-sm text-gray-500">CSV, JSON, Excel files</p>
                </div>
            </div>
        `;
    }

    function renderDataSources(dataSourceList = dataSourcesState.filteredDataSources) {
        const container = document.getElementById('datasources-container');
        const emptyState = document.getElementById('datasources-empty');
        const countElement = document.getElementById('datasources-count');
        
        console.log('Rendering data sources:', dataSourceList ? dataSourceList.length : 0);
        
        // Update count
        if (countElement) {
            const count = dataSourceList ? dataSourceList.length : 0;
            countElement.textContent = `${count} data source${count !== 1 ? 's' : ''}`;
        }
        
        if (!dataSourceList || dataSourceList.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        const renderFunction = dataSourcesState.currentView === 'grid' ? renderDataSourceCard : renderDataSourceList;
        const dataSourceItems = dataSourceList.map((dataSource, index) => renderFunction(dataSource, index)).join('');
        const uploadCard = dataSourcesState.currentView === 'grid' ? renderUploadDataSourceCard() : '';
        
        container.innerHTML = uploadCard + dataSourceItems;
        
        // Update container class
        container.className = dataSourcesState.currentView === 'grid' ? 'datasources-grid' : 'datasources-list';
    }

    function populateProjectFilter() {
        const projectFilter = document.getElementById('project-filter');
        if (!projectFilter) return;
        
        // Clear existing options except the first one
        projectFilter.innerHTML = '<option value="all">All Projects</option>';
        
        // Add projects to filter
        dataSourcesState.projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name || 'Untitled Project';
            projectFilter.appendChild(option);
        });
    }

    function populateProjectSelector() {
        const projectSelect = document.getElementById('datasource-project');
        if (!projectSelect) return;
        
        // Clear existing options except the first one
        projectSelect.innerHTML = '<option value="">Select a project...</option>';
        
        // Add projects to selector
        dataSourcesState.projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name || 'Untitled Project';
            projectSelect.appendChild(option);
        });
    }

    // Filter and sort functions
    function filterDataSources() {
        let filtered = [...dataSourcesState.dataSources];
        
        // Apply search filter
        if (dataSourcesState.searchTerm) {
            const term = dataSourcesState.searchTerm.toLowerCase();
            filtered = filtered.filter(dataSource => {
                return (dataSource.title && dataSource.title.toLowerCase().includes(term)) ||
                       (dataSource.file_name && dataSource.file_name.toLowerCase().includes(term)) ||
                       (dataSource.project_name && dataSource.project_name.toLowerCase().includes(term));
            });
        }
        
        // Apply project filter
        if (dataSourcesState.projectFilter !== 'all') {
            filtered = filtered.filter(dataSource => dataSource.project_id === dataSourcesState.projectFilter);
        }
        
        // Apply file type filter
        if (dataSourcesState.fileTypeFilter !== 'all') {
            filtered = filtered.filter(dataSource => {
                const fileType = (dataSource.file_type || '').toLowerCase();
                const fileName = (dataSource.file_name || '').toLowerCase();
                
                switch(dataSourcesState.fileTypeFilter) {
                    case 'csv':
                        return fileType.includes('csv') || fileName.endsWith('.csv');
                    case 'json':
                        return fileType.includes('json') || fileName.endsWith('.json');
                    case 'xlsx':
                        return fileType.includes('excel') || fileType.includes('spreadsheet') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                    case 'api':
                        return fileType.includes('api');
                    case 'database':
                        return fileType.includes('database') || fileType.includes('sql');
                    default:
                        return true;
                }
            });
        }
        
        // Apply status filter (placeholder for now)
        if (dataSourcesState.statusFilter !== 'all') {
            // This would filter by actual connection status
            // For now, all file uploads are considered "connected"
        }
        
        dataSourcesState.filteredDataSources = filtered;
        sortDataSources();
    }

    function sortDataSources() {
        const sorted = [...dataSourcesState.filteredDataSources];
        
        switch(dataSourcesState.currentSort) {
            case 'created_at_desc':
                sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                break;
            case 'created_at_asc':
                sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                break;
            case 'title_asc':
                sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                break;
            case 'title_desc':
                sorted.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
                break;
            case 'file_type_asc':
                sorted.sort((a, b) => (a.file_type || '').localeCompare(b.file_type || ''));
                break;
            case 'project_name_asc':
                sorted.sort((a, b) => (a.project_name || '').localeCompare(b.project_name || ''));
                break;
        }
        
        dataSourcesState.filteredDataSources = sorted;
        renderDataSources();
    }

    // Event handlers
    function handleViewToggle(view) {
        dataSourcesState.currentView = view;
        
        // Update button states
        document.getElementById('grid-view').className = view === 'grid' ? 
            'view-active px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-md focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500' :
            'view-inactive px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-md hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500';
            
        document.getElementById('list-view').className = view === 'list' ? 
            'view-active px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-md focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500' :
            'view-inactive px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-md hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-purple-500 focus:border-purple-500';
        
        renderDataSources();
    }

    function handleSearch() {
        dataSourcesState.searchTerm = document.getElementById('datasource-search').value;
        filterDataSources();
    }

    function handleSort() {
        dataSourcesState.currentSort = document.getElementById('sort-datasources').value;
        sortDataSources();
    }

    function handleProjectFilter() {
        dataSourcesState.projectFilter = document.getElementById('project-filter').value;
        filterDataSources();
    }

    function handleFileTypeFilter() {
        dataSourcesState.fileTypeFilter = document.getElementById('filetype-filter').value;
        filterDataSources();
    }

    function handleStatusFilter() {
        dataSourcesState.statusFilter = document.getElementById('status-filter').value;
        filterDataSources();
    }

    function clearFilters() {
        document.getElementById('datasource-search').value = '';
        document.getElementById('project-filter').value = 'all';
        document.getElementById('filetype-filter').value = 'all';
        document.getElementById('status-filter').value = 'all';
        document.getElementById('sort-datasources').value = 'created_at_desc';
        
        dataSourcesState.searchTerm = '';
        dataSourcesState.projectFilter = 'all';
        dataSourcesState.fileTypeFilter = 'all';
        dataSourcesState.statusFilter = 'all';
        dataSourcesState.currentSort = 'created_at_desc';
        
        filterDataSources();
    }

    // Modal functions
    function openUploadModal() {
        populateProjectSelector();
        
        const modal = document.getElementById('upload-datasource-modal');
        if (modal) {
            modal.classList.remove('hidden');
            
            const projectSelect = document.getElementById('datasource-project');
            if (projectSelect) {
                projectSelect.focus();
            }
        }
    }

    function closeUploadModal() {
        const modal = document.getElementById('upload-datasource-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        resetUploadForm();
    }

    function resetUploadForm() {
        const form = document.getElementById('upload-datasource-form');
        if (form) {
            form.reset();
        }
        
        const submitBtn = document.getElementById('upload-submit');
        const btnText = submitBtn?.querySelector('.btn-text');
        const spinner = document.getElementById('upload-spinner');
        
        if (submitBtn) submitBtn.disabled = false;
        if (btnText) btnText.textContent = 'Upload Data Source';
        if (spinner) spinner.classList.add('hidden');
        
        // Reset file info
        const fileInfo = document.getElementById('file-info');
        if (fileInfo) {
            fileInfo.classList.add('hidden');
            fileInfo.textContent = '';
        }
    }

    async function handleUploadDataSource(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = document.getElementById('upload-submit');
        const btnText = submitBtn?.querySelector('.btn-text');
        const spinner = document.getElementById('upload-spinner');
        
        const projectId = formData.get('project_id');
        const title = formData.get('title');
        const file = formData.get('file');
        
        if (!projectId) {
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Please select a project', 'error');
            }
            return;
        }
        
        if (!title.trim()) {
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Please enter a data source name', 'error');
            }
            return;
        }
        
        if (!file) {
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Please select a file to upload', 'error');
            }
            return;
        }
        
        // Show loading state
        if (submitBtn) submitBtn.disabled = true;
        if (btnText) btnText.textContent = 'Uploading...';
        if (spinner) spinner.classList.remove('hidden');
        
        try {
            const newDataSource = await uploadDataSource(projectId, formData);
            
            // Add project info to data source for display
            const project = dataSourcesState.projects.find(p => p.id === projectId);
            if (project) {
                newDataSource.project_name = project.name;
                newDataSource.project_id = projectId;
            }
            
            // Add to data sources list
            dataSourcesState.dataSources.unshift(newDataSource);
            filterDataSources();
            
            closeUploadModal();
            
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Data source uploaded successfully!', 'success');
            }
            
        } catch (error) {
            console.error('Failed to upload data source:', error);
            
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast(error.message || 'Failed to upload data source', 'error');
            }
        } finally {
            if (submitBtn) submitBtn.disabled = false;
            if (btnText) btnText.textContent = 'Upload Data Source';
            if (spinner) spinner.classList.add('hidden');
        }
    }

    // Data Sources view object
    window.DataSourcesView = {
        async init() {
            console.log('Initializing data sources view...');
            
            if (dataSourcesState.isInitialized) {
                console.log('Data sources view already initialized');
                return;
            }
            
            try {
                // Wait for layout to be ready
                let attempts = 0;
                while (!window.SnappyLearn && attempts < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.SnappyLearn) {
                    throw new Error('SnappyLearn not available');
                }
                
                console.log('SnappyLearn is ready');
                
                // Get active organization with retries
                let orgAttempts = 0;
                let activeOrg = null;
                const maxOrgRetries = 10;
                
                while (orgAttempts < maxOrgRetries && !activeOrg) {
                    try {
                        if (typeof window.SnappyLearn.getActiveOrganization === 'function') {
                            activeOrg = window.SnappyLearn.getActiveOrganization();
                        }
                    } catch (error) {
                        console.warn('Error getting active organization:', error);
                    }
                    
                    if (!activeOrg) {
                        console.log(`Waiting for organization... attempt ${orgAttempts + 1}/${maxOrgRetries}`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    orgAttempts++;
                }
                
                if (!activeOrg) {
                    throw new Error('No active organization found after retries');
                }
                
                dataSourcesState.activeOrganization = activeOrg;
                console.log('Active organization set:', activeOrg);
                
                // Update subtitle
                const subtitle = document.getElementById('datasources-subtitle');
                if (subtitle) {
                    subtitle.textContent = `Manage data connections in ${activeOrg.name}`;
                }
                
                // Fetch projects and data sources in parallel
                console.log('Fetching projects and data sources...');
                const [projects, dataSources] = await Promise.all([
                    fetchProjects(activeOrg.id),
                    fetchDataSources(activeOrg.id)
                ]);
                
                dataSourcesState.projects = projects;
                dataSourcesState.dataSources = dataSources;
                dataSourcesState.filteredDataSources = [...dataSources];
                
                console.log('Data loaded:', { projects: projects.length, dataSources: dataSources.length });
                
                // Populate filters and render
                populateProjectFilter();
                renderDataSources();
                
                // Show main content
                document.getElementById('page-loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                dataSourcesState.isInitialized = true;
                console.log('Data sources view initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize data sources view:', error);
                
                if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                    window.SnappyLearn.showToast(`Failed to load data sources: ${error.message}`, 'error');
                } else {
                    console.error('Failed to load data sources:', error.message);
                }
                
                // Show error state
                document.getElementById('page-loading').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
            }
        },
        
        retry() {
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('page-loading').classList.remove('hidden');
            dataSourcesState.isInitialized = false;
            DataSourcesView.init();
        },
        
        uploadDataSource() {
            if (dataSourcesState.projects.length === 0) {
                if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                    window.SnappyLearn.showToast('Create a project first before uploading data sources', 'info');
                }
                return;
            }
            
            openUploadModal();
        },
        
        previewDataSource(dataSourceId) {
            console.log('Preview data source:', dataSourceId);
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Data preview coming soon', 'info');
            }
        },
        
        downloadDataSource(dataSourceId) {
            console.log('Download data source:', dataSourceId);
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Download functionality coming soon', 'info');
            }
        },
        
        showDataSourceMenu(event, dataSourceId) {
            event.stopPropagation();
            console.log('Show menu for data source:', dataSourceId);
            if (window.SnappyLearn && typeof window.SnappyLearn.showToast === 'function') {
                window.SnappyLearn.showToast('Data source menu coming soon', 'info');
            }
        }
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Data sources view DOM loaded');
        
        // Initialize with a delay to ensure layout is ready
        setTimeout(() => {
            DataSourcesView.init();
        }, 1000);
        
        // View toggle
        document.getElementById('grid-view')?.addEventListener('click', () => handleViewToggle('grid'));
        document.getElementById('list-view')?.addEventListener('click', () => handleViewToggle('list'));
        
        // Search and filters
        document.getElementById('datasource-search')?.addEventListener('input', handleSearch);
        document.getElementById('sort-datasources')?.addEventListener('change', handleSort);
        document.getElementById('project-filter')?.addEventListener('change', handleProjectFilter);
        document.getElementById('filetype-filter')?.addEventListener('change', handleFileTypeFilter);
        document.getElementById('status-filter')?.addEventListener('change', handleStatusFilter);
        document.getElementById('clear-filters')?.addEventListener('click', clearFilters);
        
        // Upload modal controls
        document.getElementById('close-upload-modal')?.addEventListener('click', closeUploadModal);
        document.getElementById('cancel-upload')?.addEventListener('click', closeUploadModal);
        document.getElementById('upload-datasource-form')?.addEventListener('submit', handleUploadDataSource);
        
        // File input handling
        const fileInput = document.getElementById('datasource-file');
        const fileInfo = document.getElementById('file-info');
        
        if (fileInput && fileInfo) {
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    fileInfo.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                    fileInfo.classList.remove('hidden');
                    
                    // Auto-fill title if empty
                    const titleInput = document.getElementById('datasource-title');
                    if (titleInput && !titleInput.value) {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                        titleInput.value = nameWithoutExt;
                    }
                } else {
                    fileInfo.classList.add('hidden');
                }
            });
        }
        
        // Close modal when clicking outside
        const modal = document.getElementById('upload-datasource-modal');
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeUploadModal();
                }
            });
        }
        
        // Organization change handling
        window.addEventListener('organizationChanged', function(event) {
            console.log('Organization changed in data sources view:', event.detail?.organization);
            dataSourcesState.isInitialized = false;
            dataSourcesState.dataSources = [];
            dataSourcesState.projects = [];
            dataSourcesState.filteredDataSources = [];
            
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('page-loading').classList.remove('hidden');
            
            setTimeout(() => {
                DataSourcesView.init();
            }, 500);
        });
    });

    console.log('Data sources view script loaded');
})();
</script>